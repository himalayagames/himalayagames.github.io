NOTE: Append new versions to the BOTTOM of this file so entries stay in chronological order.

v61 — 2026-01-19
- Added targeted console snapshots around slide/flip/cleanup to diagnose post-flip vertical drop.
- Separated slide (wrapper) from flip (inner) to avoid mixing transforms.

v62 — 2026-01-19
- Added extended post-cleanup diagnostics (two rAF snapshots + 250ms snapshot) to catch the late vertical drop.
- Added ancestor container logging (shell parent, lane, lane parent, table) at every snapshot.
- Added a MutationObserver tripwire to report class/style changes on likely culprit elements.

v63 — 2026-01-19
- Changed renderHands() to preserve existing card DOM nodes during sequential dealing (append-only when possible) to prevent post-flip drop caused by lane re-render replacements.
- Reinforced vertical lock on all card shells after every render (top=0, marginTop=0, alignSelf=flex-start, translate=0 0).

v64 — 2026-01-19
- FIX: Eliminated lane-wide DOM clears/rebuilds by reconciling card shells in place (update existing shells, append missing, remove extras). This prevents the post-flip 'drop' that occurred when animated nodes were removed and replaced.
- Updated diagnostics to flattened snapshot logs for easier copy/paste and easier comparison across frames.

v65 — 2026-01-19
- Attempted fix for subtle post-flip vertical 'snap' by removing translateZ(0) GPU-promote hack from .cardShell (can cause rounding snaps at end of 3D rotation).
- Added explicit perspective-origin on .cardShell and explicit transform-origin/will-change on .cardFlip to stabilize the 3D flip projection.

v66 — 2026-01-19
- Attempted fix for post-flip vertical drift by making .cardFlip an absolutely-positioned inset(0) layer inside .cardShell (prevents any internal flow/baseline effects).
- Added translateZ(0) stabilization on .cardFlip (and preserved it when flipped) to reduce subpixel rounding changes during the end of the 3D rotation.
- Hardened box-sizing/overflow rules for shell/faces and made face images display:block to prevent tiny layout/baseline shifts.

v67 — 2026-01-19
- FIX: Eliminated remaining post-flip vertical drift by removing perspective-based 3D projection from the flip container (keeps flip rotation but prevents projection-induced Y shift).
- FIX: Removed translateZ(0) from the rotating flip frame and added backface-visibility:hidden to the frame to prevent intermittent blanking/flicker during rotation.


v68 — 2026-01-19
- FIX: Restored reliable rendering during flip by removing backface-visibility from the rotating .cardFlip frame (only faces should hide their backfaces).
- Added position: relative to .cardShell so the absolutely-positioned .cardFlip is always correctly contained.

v69 — 2026-01-19
- FIX: Eliminated flip-time disappearance by keeping the rotating .cardFlip frame continuously populated (no more clearing/removing all children during updates).
- Updated card face refresh to replace each face node in place so the rotating element always has drawable content throughout the transition.

v70 — 2026-01-19
- FIX: Restored a stable 3D projection environment by applying perspective on the non-rotating .lane (stable parent) so rotateY doesn't visually "disappear" mid-flip.
- FIX: Reduced 3D compositing blanking risk by avoiding paint containment on .cardShell (contain: layout only).

v71 — 2026-01-19
- FIX: Eliminated the reintroduced flip "drop" by removing perspective from .lane (layout/positioning context) and inserting a dedicated per-card .cardStage that owns perspective only.
- The flip hierarchy is now: .cardShell (2D slide/position) → .cardStage (projection) → .cardFlip (rotateY) → faces. This keeps the rotating frame drawable (no disappearance) while keeping layout coordinates immune to 3D re-projection.

v72 — 2026-01-19
- FIX: Removed .cardShell from the transform chain at rest (translate: none) because a non-'none' translate (even 0px 0px) can reintroduce 3D projection drift during rotateY.
- Deal slide still uses X-only translate transiently, but translate is cleared back to 'none' before and after the flip so the card no longer "drops" while flipping.

v73 — 2026-01-19
- Added .cardAnchor to separate 2D slide from 3D flip (structural prep).

v74 — 2026-01-19
- FIX: Replaced 3D rotateY flip with a pure 2D scaleX flip + crossfade between faces to eliminate vertical projection drift ('drop') while keeping the same flip timing and sounds.
- Card structure remains stable (shell → anchor → stage → flip → two faces); rotating frame always has drawable content (no disappearance).

v75 — 2026-01-19
- FIX: Addressed persistent flip-time vertical "drop" by keeping the cardAnchor in a stable translate(0px,0px) state at rest.
  Previously, toggling anchor.translate between '0px 0px' and 'none' could trigger compositor relayering that presented as a Y snap.
- Packaging: produced a clean project-root zip (no stray mnt/data folders).

v76 — 2026-01-19
- FIX: Added runtime vertical drift compensation during flip.
  Some browsers re-anchor composited layers when the flip transform begins, producing an apparent Y "drop" even with top:0 and X-only transforms.
  v76 measures shell screen-top before the flip and applies a temporary translateY correction on .cardAnchor during the flip, then restores anchor translate after cleanup.
- No changes to deal logic, timing, sounds, or slide direction.

v77 — 2026-01-19
  Fix: remove accidental duplicated flip block that introduced a JavaScript syntax error (Deal button unresponsive). No gameplay logic changes.

v78 — 2026-01-19
  Fix: remove v76 vertical "pin" compensation (translateY correction) that was causing cards to slide downward after flipping.
  No changes to deal logic, timing, sounds, or slide direction.

v79 — 2026-01-19
  Safari-first stability pass:
  - Removed use of the individual CSS `translate:` property and moved the deal slide to `transform: translate3d(...)` on .cardAnchor.
    Safari can exhibit compositor relayering/rounding glitches when mixing individual transform properties with `transform`.
  - Removed containment on .cardShell (contain: none) to reduce Safari blanking/flicker during layer promotion.
  - Fixed a stray brace / missing flip block in animateLastDealtCard (JS syntax check now clean) and reinstated the intended
    post-slide flip sequence using the existing audio-derived flip timing.

v80 — 2026-01-19
  Safari-first "boringly stable" flip:
  - Replaced the negative-matrix flip (scaleX(-1) + opacity crossfade) with a squeeze-to-zero flip:
    scaleX(1) → scaleX(0.02) → swap face visibility → scaleX(1).
    This avoids Safari compositor re-layering that can show up as a brief blink or vertical "drop" when the transform sign flips.
  - Removed opacity transitions on card faces; face swap happens at the midpoint while width is near-zero.
  - Standardized deal slide to use ONLY `transform: translate3d(...)` (no individual `translate:`) in the live inline script.
  No changes to deal logic, timing, sounds, or slide direction.
\nv81 (Safari drop fix attempt): remove inset:0 absolute wrappers (cardAnchor/cardStage/cardFlip) -> use relative sizing; add isolation:isolate on cardShell. Goal: prevent 1-card-height compositor origin jump during flip.

v82 (Safari-first stable flip):
  - Replaced two-face front/back flip stack with a single .cardVisual element per card.
  - Flip is now: scaleX squeeze -> swap content at midpoint -> scaleX expand (one element, one transform).
  - Stored front markup per shell for midpoint swap; face-up state now sets content directly.
  - Kept deal slide, timing, sounds, and direction unchanged.

=== v83 ===
Safari flip-drop structural fix: Introduced .cardMover as the ONLY element that receives slide translate3d.
Rule enforced: no transforms on positioned/layout elements (.cardShell/.cardAnchor). Flip behavior unchanged.

=== v84 ===
Fix packaging/runtime code-path mismatch:
- index.html now loads script.js (single source of truth) instead of an inlined legacy script.
- Ensures the shipped runtime actually uses the v82 single-element .cardVisual flip and the v83 .cardMover slide ownership.
No changes to deal logic, timing, sounds, slide direction, or flip behavior.

=== v85 ===
Documentation / guardrails:
- Added detailed in-code comments explaining the Safari 1-card-height post-flip drop root cause and the architectural rule:
    * NEVER transform positioned/layout elements (.cardShell/.cardAnchor)
    * ONLY transform animation-only elements (.cardMover for slide, .cardVisual for flip)
- Added an index.html warning comment to prevent reintroducing an inline legacy script (which previously caused Safari to run the wrong code path).
No gameplay, timing, sound, or animation behavior changes.

=== v86 ===
Card back + shoe-size guardrail:
- Replaced the face-down card pattern with the provided Himalaya/Everest card-back art (images/card_back_everest.png).
- Implemented a deck-count (shoe size) guardrail:
    * Deck count may be changed only before the first deal of a shoe.
    * Once any card has been dealt (shoePos > 0), deck count is locked until the next shuffle/new shoe.
    * Settings no longer force a reshuffle unless the deck count actually changes.

=== v87 ===
UX + card-back rendering fixes:
- Settings: Deck selector now clearly shows a locked/disabled look when shoe-size is locked.
- Settings: Attempting to change decks mid-shoe now immediately shows the explanatory popup and reverts the selection.
- Card back: Removed the inner border overlay and removed the paper texture overlay from face-down cards to prevent the "pip-frame"/border/texture from showing through the back.

=== v88 ===
Settings rule-lock + defaults:
- Defaults: Hit on Soft 17 = YES; Surrender = NO (and Stay/Stand on Soft 17 = NO via mutual exclusivity).
- Mid-shoe guardrail: Table rules (decks, H17/S17, surrender) cannot be changed after the first deal until the next shuffle/new shoe.
- UX: Locked rule controls are more obviously greyed/dimmed.
- UX: Attempts to interact with locked rule controls do nothing except show an explanatory popup.
- Popup layering: Informational popup now appears above Settings/About modals.

=== v89 ===
Card face proportions:
- Inner blue frame enlarged ~10%.
- Interior pips inside the frame reduced ~15%.
- Corner suit pip (below rank) enlarged ~15%.



=== v90 ===
Help / Story scroll:
- Added ? button next to the Settings gear.
- New parchment-style scroll overlay with Tibetan prayer flags.
- Unfurl animation on open; OK button to dismiss (and click outside to close).
- Added in-game story + rules/instructions text.


=== v91 ===
Bust flow + UI:
- If all player hands bust, dealer hole card is revealed but dealer does not draw.
- Gear icon enlarged; help (?) button matches gear styling (no circle).
- Disabled result popups (no in-game messaging).
- Debug/status bar no longer auto-enables on Deal.


=== v92B (Branch Point 1) ===
Branch rationale:
- We are starting this branch because too much time is being spent isolating a runtime bug.
- v91 is treated as the stable baseline so we can preserve a working game.
- This branch will be used for a separate attempt at adding graphical representations of the shoe and discard pile.

Changes in v92B:
- Removed the top-of-window debug/status banner entirely (no in-game debug UI).
- Re-enabled end-of-hand result popups (in-game messaging restored).

=== v93B (Targeted Refactor Branch) ===
- Purpose: targeted refactor scaffolding to improve maintainability and isolate runtime/state bugs without changing gameplay behavior.
- Rationale: v92B is a stable gameplay anchor; development time has been lost chasing a runtime bug and UI timing issues in tightly-coupled code. This branch begins a structural separation to support future features (especially graphical shoe + discard pile) with less risk.
- Scope (this version): no gameplay/rule/UI behavior changes intended. Introduces DOM-agnostic card container classes (Shoe/DiscardPile/Hand) in cardholders.js and loads them before script.js.

=== v94 (Gameplay/UI Fixes) ===
- Purpose: implement post-v93B observed gameplay/UI sequencing fixes (non-refactor).
- Changes:
  - Dealer total display no longer updates until AFTER the hole-card flip completes (prevents early total reveal).
  - Cut card behavior is now casino-realistic: when the cut card is reached mid-hand, the current hand finishes and the shoe is shuffled BETWEEN hands (not immediately).
  - Shuffle overlay now appears over the dealer lane in a white box with large blue text, blinks during the shuffle sound, and disappears when the sound sequence ends. It has priority over other popups.

=== v95B (Stability Repairs) ===
- Restored reliable end-of-hand result popups (including player bust).
- Dealer total sequencing hardened: total updates only after hole card is fully in place and revealed.
- Cut card behavior preserved: finish current hand, then shuffle between hands.
- Deck viewer window constrained smaller by default.


v95B — 2026-01-22
- FIX: Result popups restored: player bust now shows reliably; end-of-hand popups no longer auto-dismiss from the triggering click.
- FIX: Dealer hole-card reveal sequencing: animate the hole-card flip and update dealer totals only after the reveal completes.
- POLISH: Shuffle overlay blink frequency reduced ~50% and changed to smooth fade in/out.
- UX: Deck Viewer popup window resized to a smaller, constrained default.

=== v96B (Shuffle Overlay Timing) ===
- Shuffle overlay now follows the requested timing cycle:
  - Fully visible 1.0s
  - Fade out 0.5s
  - Hidden 0.25s
  - Fade in 0.5s
  - Fully visible 1.0s
  (repeats)
- Shuffle sound (riffle/bridge) plays exactly 3 times; overlay cycles continuously while those 3 plays are running, then completes its current cycle and disappears.


=== v97B (Dealer Total After Dealer Animations) ===
- Dealer total text is now gated by dealer card animation completion.
- Totals update only after the dealer's newly dealt card is fully in position (no changes to the card animations themselves).
- Implemented dealerVisibleCount + dealerTotalHold so the displayed total reflects only cards whose animations have completed.


=== v98B (Shoe & Discard UI Mock in Control Panel) ===
- Added shoe and discard pile tray icons to the control panel to the right of the ? button.
- Shoe tray is open at the bottom; discard tray is open at the top.
- Visual-only mock with default values: shoe 75% filled (blue), cut card line at 65%, discard 25% filled.
- No changes to game logic/model; not wired to state yet.

v99B
- Shoe & discard icons wired to real shoe state (read-only UI)
- Help/Instructions updated with Decks, Shoe, and Discards section

=== v100B (UI Stability Pass) ===
- Fixed control panel jiggle when enabling/disabling actions by making button metrics layout-stable (border space reserved; no size changes between states).
- Enabled/disabled visual changes now rely on color/opacity only; no gameplay/model/animation changes.

=== v101B (HUD Stability + Release Cleanup) ===
- Fixed minor jiggle in the upper HUD row (bankroll / bet / chips-in-action) by locking box metrics and using tabular numerals so amount changes do not reflow the layout.
- Turned DEV tools OFF for release: dev/test buttons and deck viewer are hidden.
- Replaced the schematic prayer-flag strip in the About/Instructions scroll with a realistic Tibetan prayer flags image.


v102B - UI: Cut card line pixel-stable (no drift) and prayer flags scaled 300% in About. Debug/dev tools remain OFF. (2026-01-22)

v103B - UI: About prayer flags embedded in scroll content (no overlap) + 300% size; cut card line mapping fixed to move correctly and stay within shoe fill. (2026-01-22)

v104B - UI: Prayer flags moved above About header, enlarged (+100%), cropped whitespace; reduced top gap. Cut card line now sinks with deal progress and stays inside shoe fill. (2026-01-22)

v105B - UI: Cut card line now preserves fixed distance to top/end of shoe while dealing from bottom; line moves down with each deal. About prayer flags crop adjusted so flags are visible (moved down inside crop, slightly taller crop, tighter spacing). (2026-01-22)

v106B - UI: About prayer flags visibility fix (crop/offset/background positioning) while keeping in-flow above title. (2026-01-22)

v107B - UI: About prayer flags rendered as <img> for visibility; cropped/offset for proper placement above header. No other changes. (2026-01-22)

v108B - UI: Removed About prayer flags image entirely (awaiting revised asset). No other changes. (2026-01-22)

v109B - UI: Re-added About prayer flags using newly cropped transparent PNG (in-flow above header) with simple sizing/margins. (2026-01-22)

v110B - UI: Prayer flags reduced to subtle ornamental divider (~120% width), no cropping or heavy styling. (2026-01-22)

v116B — 2026-01-22
- Settings: Soundtrack control changed from volume slider to simple Yes/No toggle (On/Off).
- Soundtrack toggle applies on ACCEPT; CLOSE discards changes.

v117B
- Added Tibetan prayer flag artwork to the top of the About screen.

v118B
- Removed legacy prayer flag assets and replaced with gimped_flags.png (clean alpha).

v119B — 2026-01-22
- Removed prayer flag image from About screen (temporary) due to transparency display issues.


v120B — 2026-01-23
- Mobile/tablet: Added responsive UI scaling via --uiScale so cards/buttons fit iPad/iPhone landscape.
- UX: Added portrait rotate overlay (landscape-only play).
- Sound: Default soundtrack OFF (still available via Settings).


v121C — 2026-01-24
- Added a single uniform scale-down wrapper (transform: scale) so the entire game shrinks proportionally on small windows.
- Baseline size is measured from the live v120B DOM at scale=1 (no hardcoded resolution); scaling is down-only and the layout at scale=1 is unchanged.
- Centered the scaled game in the viewport; added an optional "Window too small" dim overlay at extreme small sizes.


v122C — 2026-01-24
- Refined uniform scale-down wrapper vertical centering: when scaled down, center the combined dealer+player+controls block (stage-local) instead of centering unused slack space.
- Prevented the “growing gap” effect between the player lane and control panel as the window narrows.
- Shoe/discard fill: measure usable height using unscaled layout dimensions (clientHeight/offsetHeight) so fill remains consistent under transform scaling.


v123C — 2026-01-24
- Responsive scaling: added anchor-based translateY when scale < 1, blending dealer-top and HUD-bottom anchors so extra vertical slack stays visually balanced (no pooling between player lane and controls).
- Keeps v120B layout intact at scale=1; no component-level CSS changes.

v124C — 2026-01-25
- Responsive scaling fix: baseline stage height/width now measured using the true visual union of table + HUD (HUD temporarily participates in normal flow for measurement only).
- Prevents HUD/control panel overlap with dealer/player lanes when the game is scaled down as a single transformed unit.

v125 — 2026-01-25
- Responsive scaling refinement: base stage height is measured from the v120B table (as intended), with only a minimal "safety reserve" added if needed to keep the HUD clear when converted to absolute during scale-down.
- Vertical balancing now biases slightly toward the bottom anchor so the player lane stays closer to the control panel on tall viewports, reducing the perceived gap.

v126C — 2026-01-25
- Scaling architecture fix: stop transforming any ancestor of the fixed HUD/control panel (transform breaks position:fixed and causes overlaps).
- New approach scales ONLY the playfield (dealer+player) via a dedicated wrapper and keeps the HUD truly fixed to the viewport.
- Locks the player-bottom → controls-top gap to the baseline value across resizes (no growth on shrink) and prevents overlap by scaling down as needed (scale <= 1).


v127C — 2026-01-25
- Baseline measurement fix for playfield scaling: measure table/player geometry while the table is still in normal document flow, then move into the absolute transform wrapper.
- Prevents the “narrow lane / collapsed playfield” issue caused by shrink-to-fit sizing after moving into an absolute container.
- Keeps HUD/control panel fixed to viewport; playfield still scales down-only and maintains a constant player→controls gap across resizes.

v128 — 2026-01-25
- Control panel scaling: scale the control panel UI components (inside .controlsInner) at the same rate as the playfield/cards so the whole UI shrinks together on smaller viewports.
- The control panel background/leather bar remain full-bleed edge-to-edge; only the inner UI scales.
- Control panel padding and height are adjusted programmatically to match the shared scale factor (transform does not affect layout), preserving proportions and reducing crowding.

v129C — 2026-01-25
- Keep playfield + control panel shrinking together, but freeze the controls layout at its baseline width so HUD/buttons/icons never reflow or drop lines during resize.
- Center the controls UI via translate+scale as a single unit; control panel container height is derived from content + padding to reduce excess “dead felt” at the bottom.
- Restore leather rail visibility by keeping the control panel overflow visible (previous overflow clipping hid the ::after rail).
- Pin CSS --uiScale at 1.0 so we don't double-scale internal lane/card geometry on resize; scaling is handled by the wrapper transforms.

v130C — 2026-01-25
- (baseline build for v131C)

v131C — 2026-01-25
- UI: Player/Dealer lane labels and hand totals are now bright blue.
- Settings: Added “Hide Hand Totals (Yes/No)” directly under Bankroll (default Yes). This is info-only and can be toggled anytime, even mid-hand.
- When Hide Hand Totals is Yes, lane labels/totals are hidden; when No, they are shown.
- Results popup: when Hide Hand Totals is Yes, the popup includes “Dealer: …” and “Player: …” totals lines.
- Logic: Player hand totals now update only after the newly dealt player card is flipped and visible (matching dealer behavior).

v132C — 2026-01-25
- FIX: Prevent a rare early-round crash that halted dealing after the first player card flip.
  - Dealer visible-total calculation could run before any dealer cards existed, producing [undefined] and throwing.
  - Totals/labels now safely ignore missing cards (and return an empty dealer total until the upcard exists).

v133C — 2026-01-25
- Settings: “Hide Hand Totals (Yes/No)” now behaves per the updated UX:
  - Default is No (totals hidden during play).
  - Yes shows the numeric hand totals; No hides the numeric hand totals.
- UI: PLAYER/DEALER labels are always visible (so it’s always clear whose lane is whose).
- UI: PLAYER/DEALER labels remain ALL CAPS at all times (including split labels like “PLAYER – HAND 2”).
- Results popup: Dealer/Player totals lines appear only when totals were hidden during play.

v134C — 2026-01-25
- Results popup: When the hand resolves and the results popup appears, force any remaining face-down cards to flip face-up.
- Results popup: Click anywhere on the popup to dismiss it.

v135C — 2026-01-25
- Results popup: DEAL button remains clickable while results popup is visible; clicking DEAL dismisses popup and deals immediately.
- Controls: Pressing Return/Enter triggers DEAL (default action), including when results popup is visible.

v136C — 2026-01-26
- Results popup: Only clicks *inside the popup window* dismiss it (clicking outside no longer dismisses or interferes with DEAL).

v137C — 2026-01-30
- Results popup: Popup overlay is now sized tightly to the popup card so clicks on DEAL are never blocked.

v138C — 2026-01-30
- Split rounds: End-of-round results now display as a table with “Dealer gets X” plus one section per hand.
- Split rounds: Each hand shows mini card-rank icons (rank only; no suits/pips/art) and its outcome + amount.
- Split rounds: Added bottom “Total” line summarizing net win/lose/push across all hands.
- Dev/QA: Enabled dev tools so the Test Splits button is available.

v139C — 2026-01-30
- Dev/QA: Dev tools are enabled and visible.
- Dev/QA: Added a small “DEV” badge in the top-left when dev tools are enabled.

v140C — 2026-01-30
- Dev/QA: DEV badge now continuously cycles yellow → blue → yellow (1s loop).
- Totals UI: Soft hands now show only ONE total (best playable total = highest ≤ 21). No more “low / high” display.
- Split play flow: After a split, only the active hand receives its first post-split card; the player resolves Hand 1 fully before Hand 2 begins. No bouncing between hands.
- Split results popup: Mini card rank text is larger; each hand row now shows cards, hand total, and “Win/Push/Lose …$X” on the same line with fixed columns to prevent jiggling.

v141C — 2026-01-30
- Split play flow: Added a 500ms pause when advancing from one split hand to the next so the player can see the transition.
- Split results popup: Tightened spacing so hand totals/results sit closer to the mini cards while still expanding as hands grow.
- Split results popup: Increased split-results typography by ~20% so Hand labels/totals/outcomes match the Dealer/Total lines.


v142C — 2026-01-30
- Split results popup: Reworked hand-row layout to use symmetric spacing between label, cards, total, and outcome (totals/outcomes stay close to the cards).

v143 — 2026-02-01
- STEP 1 (skeleton only): Added folder structure for clean Engine/UI separation with zero intended gameplay changes.
- Desktop still runs the v142C monolith (script.js). New v143 files are placeholders + documentation headers only.
- New folders added:
  - core/        (future DOM-free engine/rules/shoe)
  - ui/desktop/  (future desktop render + controls + modals + audio + scaling)
  - dev/         (future deck viewer + diagnostics)
- index.html: loads skeleton modules before script.js.
- Plan forward:
  - Step 2: extract pure helpers into core/utils.js
  - Step 3: extract shoe into core/shoe.js (remove UI coupling)
  - Step 4: extract blackjack rules into core/rules_blackjack.js
  - Step 5: create core/engine.js state + actions; desktop becomes an engine consumer
  - Step 6: move desktop UI pieces into ui/desktop/

v143D Step 2 — 2026-02-01 — Extract pure helpers into core/utils.js (no behavior change intended)
- Moved safe, DOM-free helper functions out of script.js into core/utils.js:
  pause, max0, intMs, nextFrame, roundMoney, fmtMoney, clampToHalfDollar, digitsOnly, snapToNearest5, formatUSD0
- script.js now imports these via BJ.utils destructuring at the top.
- Purpose: allows the upcoming engine/rules modules to reuse these helpers without pulling in UI code.

v143D Step 3 — 2026-02-01 — Extract shoe/deck logic into core/shoe.js (no behavior change intended)
- Moved shoe/deck build + shuffle + draw + cut-marker logic out of script.js into core/shoe.js as BJ.shoe (DOM-free).
- script.js now keeps thin wrappers (newShuffledShoe/draw/drawSpecific/drawMatching) that call BJ.shoe and then perform UI-only reactions:
  updateDeckViewer(), updateShoeDiscardIcons(), and triggerShuffleOverlay() when an immediate reshuffle occurs (only when not inRound).
- Updated deck viewer + shoe/discard icon UI to read shoe state via BJ.shoe.getState() instead of using global shoe variables.
- Flipped DEV_TOOLS_ENABLED default to false (DEV badge and dev-only toggles are off by default).

v143D Step 3a — 2026-02-01 — Hotfix: restore legacy suit tokens for correct pip/face rendering
- Fixed core/shoe.js to emit suit names (spades/hearts/diamonds/clubs) matching the existing UI render pipeline.
- This resolves face-up card rendering showing "undefined" pips and incorrect face-card artwork.
- Gameplay/shoe behavior unchanged; this is a representation compatibility fix only.

v143D Step 4 — 2026-02-01 — Extract blackjack rule helpers into core/rules_blackjack.js (no behavior change intended)
- Moved pure blackjack helper logic out of script.js into core/rules_blackjack.js as BJ.rulesBJ:
  TEN_VALUE, cardValue(), isTenGroup(), handTotal(), handTotalDetailed(), isBlackjack(), canSplitPair().
- script.js now imports these via BJ.rulesBJ destructuring near the top.
- Purpose: these functions are the reusable "Model" layer for desktop + phone UIs and future game variants.

v143D Step 5 — 2026-02-01 — Introduce core/engine.js facade (no behavior change intended)
- Replaced the v143 placeholder core/engine.js with a real (DOM-free) engine *facade*:
  BJ.engine.createGame() now returns { getState, action, subscribe }.
- This Step 5 engine does not yet own the full blackjack orchestration; it calls through to existing legacy
  global functions (startRound/onHit/onStand/onDouble/onSplit/onSurrender) so gameplay remains unchanged.
- script.js now creates BJ.game during init (and also exposes window.game for easy console debugging).
- Purpose: establish a stable Model/Controller boundary so desktop + future phone UI can consume a single
  engine API while we progressively migrate orchestration into core/engine.js in later steps.

v143D Step 6 — 2026-02-01 — Extract desktop control wiring into ui/desktop/desktop_ui.js (no behavior change intended)
- Moved primary desktop control wiring (Deal/Hit/Stand/Double/Split/Surrender buttons + Enter-to-Deal) out of script.js
  into ui/desktop/desktop_ui.js as BJ.desktop.mountControls(...).
- script.js now calls BJ.desktop.mountControls() during init, passing closures so the helper can read legacy `let` state
  variables (inRound/gameOver/etc.) without promoting them to globals.
- Gameplay behavior is intended to be unchanged; this is a structural move preparing the next UI extractions.

v144D Step 7A — 2026-02-01 — Begin migrating DEAL/startRound sequencing into core/engine.js (no behavior change intended)
- Added a lightweight BJ.legacy adapter in script.js to expose legacy `let` state (bankroll/bet/hands/etc.), UI lane
  references, and a small set of legacy functions as hooks.
- Updated BJ.engine.createGame({ adapter }) so START_ROUND uses a new startRoundInEngine() implementation when the
  adapter is provided.
- startRoundInEngine mirrors the legacy startRound() call order and timing, but routes all state mutations through the
  adapter and calls rendering/animation via adapter hooks (engine file remains DOM-free).
- Purpose: make the engine the owner of round-start state transitions while keeping the game runnable after each step.

v145D Step 7B — 2026-02-01 — Migrate HIT (onHit) sequencing into core/engine.js (no behavior change intended)
- Implemented hitInEngine() in core/engine.js and, when a legacy adapter is provided, wired ACTIONS.HIT to use the
  engine-owned implementation instead of calling global onHit().
- hitInEngine mirrors the legacy onHit() flow: mark acted, draw one card, hold totals until flip, render/animate, bust
  detection (including single-hand immediate bust popup override), then finishHand(), setButtons(), and
  nextHandOrDealer() sequencing.
- Expanded BJ.legacy.fns in script.js to include showResultPopup, finishHand, and nextHandOrDealer so the engine can
  stay DOM-free while preserving exact legacy UI/pacing.
- Purpose: continue moving round flow/state transitions into the DOM-free engine while keeping UI rendering/animation
  responsibilities in the desktop UI + legacy hooks.

v146D Step 7C — 2026-02-01 — Migrate STAND + dealer play + settlement sequencing into core/engine.js (no behavior change intended)
- Implemented standInEngine(), nextHandOrDealerInEngine(), and dealerPlayAndSettleInEngine() in core/engine.js and wired
  ACTIONS.STAND to use the engine-owned implementation when a legacy adapter is provided.
- nextHandOrDealerInEngine mirrors legacy nextHandOrDealer(): advances across split hands (including the needsSplitCard
  flow and split-aces auto-stand behavior) and calls dealerPlayAndSettleInEngine when all player hands are done.
- dealerPlayAndSettleInEngine mirrors the legacy dealerPlayAndSettle(): reveal dealer hole card, dealer draw loop with
  soft-17 rule, outcome determination (win/lose/push/blackjack), bankroll settlement, and end-of-round state transitions.
  All UI work (rendering, animations, popups, highlights, cycling results) is performed via adapter hooks so the engine
  remains DOM-free.
- Expanded BJ.legacy adapter in script.js with dealer visibility/hold state and additional UI/legacy hooks needed by the
  engine (updateLabels, animateRevealDealerHoleCard, split summary popup helpers, highlights/cycleResults, etc.).
- Purpose: make the engine the owner of full round completion (player stand → dealer → settle → round end) while keeping
  the desktop UI responsible only for rendering/animation.

v147D Step 7D1 — 2026-02-02 — Migrate DOUBLE (onDouble) sequencing into core/engine.js (no behavior change intended)
- Implemented doubleInEngine() in core/engine.js and, when a legacy adapter is provided, wired ACTIONS.DOUBLE to use the
  engine-owned implementation instead of calling global onDouble().
- doubleInEngine mirrors the legacy onDouble() flow: validate 2-card hand, insufficient-funds modal with retry, deduct
  additional wager, double the hand wager, update HUD, mark doubledThisHand, draw exactly one card with total-hold,
  render/animate, then finishHand(), setButtons(), and nextHandOrDealer() sequencing.
- Purpose: continue completing the round/action migration so UI only issues game.action(...) while engine owns state
  transitions and legality.

v148D Step 7D1b — 2026-02-02 — Fix DOUBLE-to-bust popup + enable Dev Tools for easier split testing
- Fixed engine DOUBLE action (doubleInEngine) to show the same immediate single-hand bust popup as HIT, so a DOUBLE bust
  always gives player feedback even when dealer settlement short-circuits due to all-player-busted.
- Enabled DEV_TOOLS_ENABLED so the on-screen dev controls (e.g., Test Splits) are visible for QA without affecting normal
  gameplay unless toggled.

v149D Step 7D1c — 2026-02-02 — Fix split-round DOUBLE-bust end-of-round results popup (no behavior change intended)
- Fixed engine dealerPlayAndSettleInEngine() early-exit path when all player hands have busted: split rounds now still
  show the legacy-style split summary popup with per-hand outcomes and round delta, instead of ending silently.
- Purpose: preserve user feedback parity with legacy behavior during split-hand rounds where dealer play short-circuits.

v150D Step 7D2 — 2026-02-02 — Migrate SPLIT (onSplit) sequencing into core/engine.js (no behavior change intended)
- Implemented splitInEngine() in core/engine.js and, when a legacy adapter is provided, wired ACTIONS.SPLIT to use the
  engine-owned implementation instead of calling global onSplit().
- splitInEngine mirrors legacy onSplit(): validate split eligibility (2-card pair / ten-group), enforce max split hands,
  insufficient-funds modal with retry, deduct additional wager, create two split hands with needsSplitCard flag, deal and
  animate ONLY the active (first) split hand’s next card, and preserve split-aces auto-stand behavior.
- Purpose: complete player-action migration so split-hand creation/progression is engine-owned, keeping UI purely input + render.
v151D Step 7D3 — 2026-02-02 — Migrate INSURANCE offer/peek/early-BJ settlement into core/engine.js (no behavior change intended)
- Engine now owns insurance offer + dealer peek + early blackjack settlements (dealer BJ / player BJ) in core/engine.js.
- Added engine-mode insurance modal bridge (awaitInsuranceEngine) so the UI collects the wager but the engine applies bankroll/insurance state.
- Added adapter hooks for awaitInsuranceEngine and showInsuranceResultModal.
- Purpose: complete action/round migration so insurance behavior is engine-owned and consistent with the refactor architecture.

v152D Step 7D4 — 2026-02-02 — Cleanup: extract desktop audio + result popup helpers out of script.js (no behavior change intended)
- Moved deal/flip + riffle sound effect setup and playback into ui/desktop/desktop_audio.js; preserved legacy global function names.
- Moved result popup + split-results table builder into ui/desktop/desktop_modals.js; preserved legacy global function names.
- Updated the result-popup dismiss click handler in script.js to use the extracted modal helpers.
- Purpose: shrink script.js to focus on bootstrap + wiring, while keeping UI behavior unchanged.

v153D — 2026-02-02 — Hotfix: restore SFX after v152D cleanup
- Fixed ui/desktop/desktop_audio.js to correctly read the top-level GAME_SOUNDS_ON flag (top-level `let` is not a window property).
- Result: deal/flip and riffle sound effects play again when sounds are enabled.

v154D — 2026-02-02 — Persistence: bankroll + rolling ledger + Graph Winnings (no gameplay changes intended)
- Added a modular persistence layer (persistence/storage.js, persistence/ledger.js, persistence/persist_controller.js).
- Persisted data: bankroll + a rolling bankroll-per-hand ledger (last 2,000 completed hands) saved to localStorage.
- On boot (between rounds), the saved bankroll is restored automatically.
- Engine emits an optional adapter hook (adapter.onRoundSettled) so persistence can log completed rounds without UI entanglement.
- Added a Settings button: GRAPH WINNINGS, opening a simple modal line chart of bankroll per hand.
- Set DEV_TOOLS_ENABLED default to false.

v155D — 2026-02-02 — Persistence: Clear Data + reset bankroll
- Added a Settings button: CLEAR DATA (next to GRAPH WINNINGS).
- CLEAR DATA opens a confirmation modal; NO cancels, YES deletes saved localStorage data and clears the graph ledger.
- After clearing data, bankroll resets to $500 and is immediately re-saved as the new baseline.

v156D — 2026-02-02 — Bugfix: shuffle freeze + insurance-decline hole reveal
- Fixed shuffle overlay freeze by removing dependency on the legacy riffleSfxBase global (audio is now module-owned).
- Added a try/finally guard to the shuffle overlay so the UI can never remain locked if audio/animation fails.
- Ensured the dealer hole card is always revealed after settlement by re-rendering immediately after holeDown=false in dealerPlayAndSettle().

v157 — 2026-02-02
- FIX: Added end-of-round safety reveal to ensure any dealer face-down cards (hole card) are flipped face-up after settlement (covers insurance-declined + player-blackjack edge cases).
- UI: Settings modal now always renders above end-of-round popups.
- FEATURE: Added cut card controls in Settings:
  - Random Cut Card (Yes/No). Default No.
  - Deck Penetration slider (65%–90% in 5% steps). Default 75%.
  - When Random Cut Card = Yes, slider is shown but disabled and pinned at 75%.
  - When Random Cut Card = No, slider is enabled and sets a deterministic cut marker position.

v158D — 2026-02-03 — Low-risk refactor: canonical round-end finalizer + centralized overlay z-indexes (no gameplay changes intended)
- Added a single authoritative end-of-round finalizer (endOfRoundFinalizeOnce) that flips any dealer face-down cards, then performs a final render/labels/HUD/buttons refresh.
- Result popup reveal logic now prefers the canonical finalizer (desktop_modals.js) and falls back to the legacy direct reveal only if needed.
- Centralized overlay layering via CSS variables: --z-modalBase, --z-popup, --z-help, --z-settings (Settings remains always above result popups).

v159D — 2026-02-03 — Layering fix: Graph/Clear Data modals above Settings; Settings above end-of-round popups
- Added --z-settingsTools and applied it to Bankroll Graph + Clear Data modals so they always stack above Settings.
- Preserved the existing rule that Settings stacks above end-of-round/result popups.

v162D — 2026-02-15
- Added KO Training Mode (Settings → Training Mode Yes/No; default No).
- Engine-side KO running count stored in core/shoe.js (2–7 +1, 8–9 0, 10–A −1).
- Running count updates only when cards become visible (player cards, dealer upcard, revealed hole card, subsequent hits).
- COUNT HUD pill appears to the right of Chips in Action when Training Mode is enabled; hover-to-reveal on hover-capable devices, tap-to-toggle on touch devices.
- About/Instructions updated under Game Persistence with Training Mode description and KO IRC/Key Count reference table.

v163D — 2026-02-15
- UI: Fixed COUNT pill layout so it sits as its own small HUD box (no longer nested inside Chips in Action).
- UI: Reduced COUNT pill width/typography so it behaves like a compact "bubble" and does not span the row.


v164D — 2026-02-15
- UI: Kept COUNT bubble on the same top HUD line by preventing desktop wrap (nowrap) and only allowing wrap on smaller screens (<980px).
- UI: Made COUNT bubble smaller (min-width 120px) and allowed Chips in Action to flex/shrink so COUNT can sit immediately to its right.
- UI: Slightly reduced fixed min-widths of the top HUD boxes to preserve spacing.

v166D — 2026-02-15
- UI: COUNT pill now sizes to the label by default (no extra empty width to the right when the value is hidden).
- UI: COUNT value display is controlled via a .revealed class; when hidden, the value element does not reserve layout space.
- Engine: KO running count now initializes to the standard KO IRC based on number of decks (IRC = -4 * (decks - 1)); applied on new shoe / deck-setting change (via newShuffledShoe).


v166D (2026-02-15)
- Fix: KO running count now updates reliably during initial deal by referencing window.BJ.shoe directly (avoids BJ scope issues).


v168D (2026-02-15)
- Refactor: KO counting rebuilt as an independent event-driven module (core/ko_counter.js).
- Each card now has a unique id at shoe creation (core/shoe.js).
- UI dispatches cardRevealed on flip midpoint; KO module dedupes by id and emits countUpdated.
- Training Mode UI behavior unchanged; count pill now reads from koCounter state.


v169D (2026-02-15)
- Fix: KO counter now normalizes rank strings (e.g., "KING"/"K", "ACE"/"A", "T"/"10") before tagging, preventing off-by-one errors when UI emits word ranks.



v170D (2026-02-15)
- FIX: KO counting now emits `cardRevealed` for initially face-up cards at render time (initial deal upcards were not counted, which could show as off-by-one during blackjack or early hands).


v171D (2026-02-15)
- Fix KO counting for dealer blackjack/instant hole-card reveals: when an existing face-down card shell is updated in-place to face-up (no flip animation), emit `cardRevealed` so the hole card (often Ace) is counted correctly.


v172D (2026-02-15)
- Training Mode: when a cut-card shuffle is triggered between hands, show a blocking modal with the final running count before the shoe resets.
- While the modal is visible, all controls are disabled; pressing OK dismisses it, reshuffles, and resets the running count to the correct IRC for the selected deck count.


v173D (2026-02-15)
- Debug tools: add one-shot buttons to force Player Blackjack or Dealer Blackjack using the normal dealing/animation pipeline (no gameplay logic changes).


v174D (2026-02-16)
- Debug Training Mode: when debugMode is enabled, the COUNT pill remains continuously revealed (running count always visible) on hover-capable devices; when debugMode is off, COUNT reverts to normal hover/tap reveal behavior.

v175D — 2026-02-16
- Set debugMode = true by default.
2026-02-16 - v175D hotfix: DEV_TOOLS_ENABLED defaults ON; unified dev flag; force blackjack buttons enabled; running count displays/updates continuously in dev tools.


v176D — 2026-02-16
- Set DEV_TOOLS_ENABLED = false by default.
