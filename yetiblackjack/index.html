<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"/>
<title>Yeti Blackjack</title>
<script>
  // Single source of truth for the running build.
  const APP_VERSION = "Yeti Blackjack v176D";
</script>
<!-- Libre Baskerville -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>:root{
  color-scheme:dark;
  --felt:#061a14;
  --felt2:#03211a;
  --gold:#d7b45a;
  --uiScale: 1;


  /* v158D+: Centralized overlay z-indexes */
  --z-modalBase: 10000;
  --z-popup: 20050;      /* end-of-round/result popups */
  --z-help: 10020;       /* help scroll */
  --z-settings: 30060;   /* settings modal */
  --z-settingsTools: 40080; /* graph + clear-data confirmations */
  /* Card size (shrunk ~15% vs earlier) */
  --cardW: calc(204px * var(--uiScale));
  --cardH: calc(286px * var(--uiScale)); /* ~1.4 ratio */
  --radius: calc(22px * var(--uiScale));

  --paper:#f7f3eb;
  --ink:#121212;
  --red:#b10d2e;

  --hudFont: calc(26px * var(--uiScale));
  --hudBoxH: calc(64px * var(--uiScale));

  --glowA: rgba(70, 150, 255, .95);
  --glowB: rgba(255, 215, 90, .95);
  --glowW: 10px; /* 2x-ish */
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
color:#f2f2f2;

  /* v46: felt covers full window + true 50% stagger */
  background-image: url('images/himalaya_felt_tile_staggered_qshift.png'), linear-gradient(180deg, var(--felt), var(--felt2));
  background-repeat: repeat, no-repeat;
  background-size: auto, cover;
  background-position: 0 0, 0 0;
}

/* Terminal end-state: disable all gameplay interactions */
body.gameOver .table,
body.gameOver .controls{
  pointer-events:none;

  z-index: 5000;
}
body.gameOver{
  cursor: default;
}

.table{
  min-height:100vh;
  padding: calc(18px * var(--uiScale)) calc(16px * var(--uiScale)) calc(150px * var(--uiScale));
  max-width: 1180px;
  margin:0 auto;
background-repeat: repeat;
background-position: 0 0;
}

.area{
  margin:14px 0;
  padding:14px 14px 16px;
  border-radius:18px;
  border:1px solid rgba(215,180,90,.28);
  background: rgba(0,0,0,.20);
  position:relative;
}

.headerline{
  display:flex;
  align-items:baseline;
  gap:10px;
  margin:0 0 10px;
  font-weight:900;
  letter-spacing:.18em;
  /* text-transform removed to preserve exact label casing */
  color:var(--gold);
  font-size:16px;
}
.headerline .value{
  color:#f6f0e6;
  letter-spacing:0;
  font-weight:900;
  font-size:16px;
}

/* v131C: Bright blue lane labels + totals (when shown) */
#dealerLabel, #playerLabel, #dealerValue, #playerValue{
  color:#18A7FF !important;
}

/* v133C: Keep labels ALL CAPS at all times */
#dealerLabel, #playerLabel{ text-transform: uppercase; }

/* v133C: Hide ONLY the numeric totals when "Hide Hand Totals" is YES (default).
   The PLAYER/DEALER labels always remain visible for clarity. */
body.hideHandTotals #dealerValue,
body.hideHandTotals #playerValue{
  visibility:hidden;
}

.lane{
  /* v60: lane is a positioning context; cards are absolutely positioned to prevent post-flip flex reflow drops */
  position: relative;
  display: block;
  overflow: visible;
  min-height: calc(var(--cardH) + 6px);
  /* v71: lane should stay purely 2D. If lane owns perspective, the browser can reproject the card's
     bounding box during rotateY and cause apparent vertical drift ("drop"). */
  perspective: none;
}

/* overlap when many cards (stacked look)
   v60: overlap is now handled by absolute left offsets in JS (see layoutLaneCards) */

/* Card shell provides 3D perspective + slide-in transforms */
.cardShell{
  width:var(--cardW);
  height:var(--cardH);
  flex: 0 0 auto;
  position: relative;
  /* v56: lock vertical resting position inside flex lanes */
  align-self: flex-start;
  margin-top: 0;
  /* v67: keep perspective off the per-card shell to avoid projection drift. */
  perspective: none;
  /* v79: Keep the shell out of the transform chain at rest.
     IMPORTANT: avoid the individual `translate:` property entirely for Safari stability.
     Slide/flip transforms live on inner wrappers instead. */
  /* Avoid GPU-promote translateZ hacks here; they can cause end-of-flip rounding snaps.
     If we want promotion, do it on the rotating element instead. */
  transform: none;
  /* v72: don't pre-promote the shell; promotion belongs on the rotating element */
  will-change: auto;
  box-sizing: border-box;
  /* v79: Safari stability ‚Äî avoid containment on animated/composited card wrappers.
     Even layout-only containment can interact poorly with layer promotion during transforms. */
  contain: none;
  isolation: isolate;
}

/*
  SAFARI COMPOSITOR SAFETY (v84 fix)
  - DO NOT put transforms on positioned/layout elements.
  - .cardShell & .cardAnchor are stable layout wrappers (NEVER transformed).
  - .cardMover is the ONLY slide transform owner (translate3d).
  - .cardVisual is the ONLY flip transform owner (squeeze scaleX).
*/
.cardAnchor{
  position:relative;
  width:100%;
  height:100%;
  /* v83: SAFARI RULE ‚Äî no transforms on positioned/layout elements.
     Anchor is a stable containing block only (never transformed). */
  transform: none !important;
  will-change: auto;
  overflow:visible;
}

/* v83: Slide mover ‚Äî ONLY element that receives translate3d for dealing/positioning */
.cardMover{
  position:relative;
  width:100%;
  height:100%;
  transform: translate3d(0px,0px,0px);
  will-change: transform;
  overflow:visible;
}

/* Projection stage lives under the mover */
.cardStage{
  position:relative;
  width:100%;
  height:100%;
  /* v74: Use a pure 2D flip (no perspective). This removes 3D projection drift that caused the vertical drop. */
  perspective: none;
  overflow: visible;
}

/* v82: single visual element flip (Safari-first)
   One element, one transform, swap content at midpoint. */
.cardVisual{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  box-sizing:border-box;
  transform: translate3d(0px,0px,0px) scaleX(1);
  transform-origin: 50% 50%;
  will-change: transform;
}

.cardShell.dealEnter{
  /* Fallback: start well off-screen to the right */
  transform: translate3d(120vw,0px,0px);
}

.cardShell.dealSlide{
  transition: transform var(--slideDur, .35s) ease-out;
  transform: translate3d(0px,0px,0px);
}

.cardFlip{
  width:100%;
  height:100%;
  position:relative;
  box-sizing:border-box;
  /* v80: Safari-first "boringly stable" flip.
     Avoid negative scale (scaleX(-1)) because Safari can re-rasterize/re-layer
     when the transform matrix sign flips, which often shows up as a blink or a
     subtle vertical "drop".
     Strategy: squeeze to near-zero, swap faces, expand back to 1.
     The only animated property is transform on this inner wrapper.
  */
  transform: scaleX(1);
  transform-origin: 50% 50%;
  transition: transform var(--flipDur, .15s) ease-in-out;
  will-change: transform;
}

.cardFace{
  position:absolute;
  inset:0;
  box-sizing:border-box;
  overflow:hidden;
  /* v80: No opacity animation during the flip.
     We swap which face is visible at the midpoint (when scaleX is ~0).
     Opacity transitions can force repaints on Safari while composited.
  */
  transition: none;
}

.cardFace.backFace{
  opacity: 1;
}

.cardFace.frontFace{
  opacity: 0;
}

/* v80: face selection (no mirroring). */
.cardFlip.isFront .cardFace.backFace{ opacity: 0; }
.cardFlip.isFront .cardFace.frontFace{ opacity: 1; }

/* Card base (always opaque; no opacity animation) */
.card{
  width:var(--cardW);
  height:var(--cardH);
  border-radius:var(--radius);
  background: var(--paper);
  color: var(--ink);
  box-shadow: 0 18px 36px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.35) inset;
  position:relative;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.10);
/* inner faces are not flex items */
}

/* Paper texture for front (face-up) cards only */
.card:not(.back)::before{
  content:"";
  position:absolute; inset:0;
  opacity:.22;
  background-image: radial-gradient(rgba(0,0,0,.08) 1px, transparent 1px);
  background-size: 7px 7px;
pointer-events:none;
}

/* face-down */
.card.back{
  /* v86: Card back art (Everest/Himalaya). */
  background:
    url('images/card_back_everest.png') center/cover no-repeat,
    #0e2a4d;
}


/* Pip card indices */
.corner{
  position:absolute;
  left:12px; top:10px;
  display:flex;
  flex-direction:column;
  gap:0px;
  font-family: "Libre Baskerville", ui-serif, Georgia, "Times New Roman", Times, serif;
  font-weight:700;
  letter-spacing:-.02em;
  line-height:1;
  z-index:5;
}
.corner .rank{font-size:32px}
.corner .suit{font-size:42px; margin-left:2px} /* v89: enlarge corner pip ~15% */
.corner.bottom{
  left:auto; top:auto;
  right:14px; bottom:12px;
  transform: rotate(180deg);
  transform-origin:center;
}
.red{color:var(--red)}
.black{color:var(--ink)}

/* Inner frame like reference */
.inner-frame{
  position:absolute;
  left:47px; top:70px; right:47px; bottom:45px; /* v89: enlarge frame ~10% */
  border:3px solid rgba(40,90,150,.65);
  border-radius:14px;
  z-index:1;
}

/* Pips */
.pip-area{
  position:absolute;
  left:47px; top:70px; right:47px; bottom:45px; /* v89: match enlarged frame */
  z-index:2;
  font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif;
}
.pip{
  position:absolute;
  transform: translate(-50%,-50%);
  font-size:22px; /* v89: reduce interior pips ~15% */
  line-height:1;
  user-select:none;
}
.pip.small{font-size:20px} /* v89: reduce interior pips ~15% */
.pip.large{font-size:37px} /* v89: reduce interior pips ~15% */

/* Art-only cards (face + special Ace) */
.artOnly{
  position:absolute;
  inset:0;
  z-index:3;
}
.artOnly img{
  width:100%;
  height:100%;
  object-fit: cover;  /* fill window */
  display:block;
}

/* Controls HUD */
.controls{
  position:fixed;
  left:0; right:0; bottom:0;
  background: rgba(0,0,0,.86);
  border-top:3px solid rgba(215,180,90,.55);
  padding:14px 14px 16px;
}
.controlsInner{
  max-width:1180px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:flex-start; /* left aligned */
}

/* Top row: bankroll + bet (same line) */
.hudRow{
  display:flex;
  gap:16px;
  align-items:center;
  /* keep HUD on one line on desktop; allow wrap on smaller screens */
  flex-wrap:nowrap;
}

@media (max-width: 980px){
  .hudRow{ flex-wrap:wrap; }
}

.hudBox{
  box-sizing: border-box;
  height: var(--hudBoxH);
  padding: 10px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  gap:12px;
  font-weight:900;
}
.hudBox .label{ font-size:16px; letter-spacing:.12em; text-transform:uppercase; color: rgba(255,255,255,.75); white-space: nowrap; }
.hudBox .amount{ font-size: var(--hudFont); color:#f7e6b0; letter-spacing:.02em; }

#countBox{ 
  cursor:pointer; 
  user-select:none; 
  -webkit-user-select:none;
  /* v166D: size the pill to the label by default (value is hidden unless revealed) */
  min-width: unset;
  width: fit-content;
  padding: 10px 14px;
  justify-content: center;
  gap: 10px;
}
#countBox .label{ font-size:14px; letter-spacing:.14em; }
#countBox .amount{ display:none; text-align:right; font-variant-numeric: tabular-nums; }
#countBox.revealed .amount{ display:inline; }
#bankrollBox .amount{ min-width: 9ch; text-align:right; font-variant-numeric: tabular-nums; }
#betBox .amount{ min-width: 7ch; text-align:right; font-variant-numeric: tabular-nums; }
#actionBox .amount{ min-width: 9ch; text-align:right; font-variant-numeric: tabular-nums; }

/* Lock HUD box widths so digit changes never reflow the row */
#bankrollBox{ min-width: 250px; }
#betBox{ min-width: 300px; }
#actionBox{ min-width: 280px; flex: 1 1 auto; }


.betControls{
  display:flex;
  align-items:center;
  gap:12px;
}
.arrowBtn{
  border:none;
  background:transparent;
  font-size: 34px;
  font-weight:900;
  padding:0 6px;
  cursor:pointer;
  line-height:1;
}
.arrowDown{ color: #ff4b4b; }
.arrowUp{ color: #38d16a; }
.arrowBtn:disabled{ opacity:.35; cursor:not-allowed; }

.actionsRow{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  align-items:center;
}

/* v135C: Keep DEAL clickable even when result popup overlay is visible */
#dealBtn{ position: relative; z-index: 20100; }
.btn{
  box-sizing: border-box;
  font-size:28px;
  padding:18px 26px;
  border-radius:18px;
  border:2px solid transparent; /* reserve border space to prevent layout jiggle */
  font-weight:900;
  cursor:pointer;
  background:#111;
  color:#8a8a8a;
}
.btn.secondary{
  /* Secondary buttons follow the same enabled/disabled styling as primary */
  background:#111;
  color:#8a8a8a;
  border-color: rgba(255,255,255,.16);
}
.btn:not(:disabled){
  background:#f7d46b;
  color:#111;
  border-color: rgba(0,0,0,0.18); /* keeps same border width */
}
.btn:disabled{
  opacity: .72;
  cursor:not-allowed;
  background:#111;
  color:#707070;
  border-color: rgba(255,255,255,.14); /* keeps same border width */
}

/* Visual cue for default action (Enter key) */
.btn.defaultBtn:not(:disabled){
  outline: 3px solid rgba(0,0,0,0.35);
  outline-offset: 2px;
}

/* Gear icon */
.gear{
  font-size: 88px; /* bigger */
  border:none;
  background:transparent;
  color:#f7e6b0;
  cursor:pointer;
  padding:0 6px;
}
.gear:active{ transform: scale(.98); }

/* Help (?) button */
.helpBtn{
  font-size: 72px;
  font-weight: 900;
  border:none;
  background:transparent;
  color:#f7e6b0;
  cursor:pointer;
  padding:0 8px;
  margin-left: 6px;
  line-height: 1;
}
.helpBtn:hover{ filter: brightness(1.06); }
.helpBtn:active{ transform: scale(.98); }
.helpBtn:focus{ outline: 3px solid rgba(0,0,0,0.35); outline-offset: 2px; }


/* Shoe + Discard icons (v98B) */
.shoeDiscardWrap{
  display:flex;
  gap:10px;
  align-items:flex-end;
  margin-left: 6px;
}

/* Base tray: rectangle with thick white border */
.trayIcon{
  position: relative;
  height: 126px;      /* ~1.75x the ? icon height */
  width: 63px;        /* height is ~2x width */
  box-sizing: border-box;
  border: 4px solid rgba(255,255,255,0.92);
}

/* Shoe tray: opening at the bottom (no bottom border) */
.trayIcon.shoeTray{
  border-bottom: none;
}

/* Discard tray: opening at the top (no top border) */
.trayIcon.discardTray{
  border-top: none;
}

.trayIcon .usable{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height: 90%;        /* usable region */
}

/* Default mock values (percent of usable height) */
.trayIcon{
  --shoeFillPx: 0;     /* px */
  --cutPx: 0;      /* px from bottom of usable area */
  --discardFillPx: 0;  /* px */
}

.shoeFill{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height: calc(var(--shoeFillPx) * 1px);
  background: #2e8bff;
}

.cutCardLine{
  position:absolute;
  left:0;
  right:0;
  bottom: calc(var(--cutPx) * 1px);
  height: 4px;
  background: #ffd400;
}

.discardFill{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height: calc(var(--discardFillPx) * 1px);
  background: rgba(255,255,255,0.45);
}

/* Help Scroll Modal */
#helpModal.modalOverlay{
  z-index: var(--z-help); /* above settings */
  background: rgba(0,0,0,0.40);
}
#helpModal.hidden{ display:none; }

/* v157: Settings must always appear above end-of-round popups */
#settingsModal.modalOverlay{
  z-index: var(--z-settings);
}

/* v161D: Graph + Clear Data modals must appear above Settings */
#bankrollGraphModal.modalOverlay,
#clearDataModal.modalOverlay{
  z-index: var(--z-settingsTools);
}


.scrollWrap{
  width: min(860px, 92vw);
  max-height: 86vh;
  pointer-events: auto;
  transform-origin: top center;
  transform: translateY(-20px) scaleY(0.08);
  opacity: 0;
  transition: transform 420ms cubic-bezier(.22,1,.36,1), opacity 260ms ease;
}
#helpModal.open .scrollWrap{
  transform: translateY(0) scaleY(1);
  opacity: 1;
}

/* parchment card */
.scrollCard{
  position: relative;
  border-radius: 18px;
  padding: 22px 26px 18px;
  overflow: hidden;
  box-shadow: 0 18px 46px rgba(0,0,0,0.45);
  border: 2px solid rgba(70,45,18,0.35);
  background:
    radial-gradient(1200px 520px at 50% 18%, rgba(255,255,255,0.34), rgba(255,255,255,0) 60%),
    radial-gradient(900px 380px at 30% 40%, rgba(140,90,30,0.14), rgba(255,255,255,0) 65%),
    radial-gradient(900px 420px at 75% 60%, rgba(120,75,25,0.12), rgba(255,255,255,0) 70%),
    linear-gradient(180deg, #f6e6b1, #efd89a 36%, #e7cf88 100%);
}

/* subtle paper grain */
.scrollCard::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity: 0.22;
  background-image:
    repeating-radial-gradient(circle at 20% 30%, rgba(60,40,20,0.05) 0 1px, transparent 1px 4px),
    repeating-radial-gradient(circle at 70% 60%, rgba(60,40,20,0.04) 0 1px, transparent 1px 5px);
}

/* aged edges */
.scrollCard::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(closest-side at 50% 0%, rgba(0,0,0,0.22), transparent 58%),
    radial-gradient(closest-side at 0% 50%, rgba(0,0,0,0.20), transparent 62%),
    radial-gradient(closest-side at 100% 50%, rgba(0,0,0,0.20), transparent 62%),
    radial-gradient(closest-side at 50% 100%, rgba(0,0,0,0.24), transparent 60%);
  opacity: .45;
}

/* scroll top roll */
.scrollTopRoll{
  position:absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  width: 86%;
  height: 34px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(120,85,40,0.35), rgba(255,255,255,0) 70%);
  box-shadow: 0 8px 18px rgba(0,0,0,0.22);
  border: 1px solid rgba(70,45,18,0.22);
  opacity: 0.75;
}

/* Prayer flags strip (in-flow, scrolls with text) */
.prayerFlags{
  display:block;
  position: relative;         /* in normal flow */
  left: 50%;
  transform: translateX(-50%); /* center wide element */
  height: 330px;              /* 300% of 110px */
  width: 276%;                /* ~300% of 92% container */
  max-width: none;
  margin: 10px 0 18px;
  background: url('images/gimped_flags.png') center / contain no-repeat;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.22));
  pointer-events: none;
}
/* content */
.scrollContent{
  position: relative;
  max-height: calc(86vh - 130px);
  overflow: auto;
  padding-right: 8px;
  color: #2a1b0d;
  font-family: "Copperplate", "Papyrus", "Palatino Linotype", "Georgia", serif;
  font-size: 16px;
  line-height: 1.42;
}
.scrollContent h2{
  font-size: 26px;
  margin: 8px 0 10px;
  letter-spacing: 0.2px;
}
.scrollContent h3{
  font-size: 18px;
  margin: 18px 0 8px;
}
.scrollContent p{ margin: 10px 0; }
.scrollContent ul{ margin: 8px 0 12px 22px; }
.scrollContent li{ margin: 6px 0; }
.scrollContent .ruleBlock{ margin: 12px 0; }

/* OK button */
.scrollOkRow{
  position: relative;
  display:flex;
  justify-content:center;
  padding-top: 8px;
}
#helpOkBtn{
  min-width: 160px;
  padding: 12px 18px;
  font-family: inherit;
  font-size: 18px;
  border-radius: 12px;
  border: 2px solid rgba(70,45,18,0.35);
  background: rgba(255,255,255,0.35);
  cursor: pointer;
}
#helpOkBtn:hover{ background: rgba(255,255,255,0.48); }
#helpOkBtn:active{ transform: scale(.98); }

/* About footer version */
.about-version{
  margin-top: 14px;
  font-size: 12px;
  color: rgba(255,255,255,0.65);
  text-align: center;
}


/* Winner glow animation */
@keyframes glowShift{
  0%   { box-shadow: 0 0 0 var(--glowW) var(--glowA), 0 0 28px rgba(70,150,255,.55); }
  50%  { box-shadow: 0 0 0 var(--glowW) var(--glowB), 0 0 28px rgba(255,215,90,.55); }
  100% { box-shadow: 0 0 0 var(--glowW) var(--glowA), 0 0 28px rgba(70,150,255,.55); }
}
.area.winGlow{
  animation: glowShift 1s linear infinite;
}
.area.dim{ opacity:.55; }

.smallRow{
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}

/* v101B: Production build hides dev/test controls (JS also enforces this). */
#devToolsRow{ display:none; }

/* v140C: DEV badge (visible only when DEV_TOOLS_ENABLED/DEBUG is true via JS) */
#devBadge{
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10005;
  display: none;
  padding: 6px 10px;
  border-radius: 10px;
  font-weight: 900;
  letter-spacing: 1px;
  font-size: 14px;
  border: 2px solid rgba(0,0,0,.35);
  box-shadow: 0 6px 18px rgba(0,0,0,.35);
  background: #ffd400;
  color: #000;
  user-select: none;
  pointer-events: none;
  /* v140C: continuously cycle yellow ‚Üí blue ‚Üí yellow over 1 second */
  animation: devBadgeShift 1s linear infinite;
}
@keyframes devBadgeShift{
  0%   { background:#ffd400; color:#000; }
  50%  { background:#2f6dff; color:#fff; }
  100% { background:#ffd400; color:#000; }
}
.toggle{
  background:#222;
  color:#f7e6b0;
  border:2px solid rgba(215,180,90,.35);
  padding:10px 14px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  font-size:18px;
}

@media (max-width:520px){
  :root{ --cardW: 170px; --cardH: 238px; --hudFont: 22px; --hudBoxH: 58px; }
  .btn{ font-size:22px; padding:14px 18px; }
  .gear{ font-size:76px; }
  .lane.overlap .card{ margin-left: calc(var(--cardW) * -0.5); }
}


/* Result popup */

/* Insurance popup */
.insOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 9998;
}
.insOverlay.hidden{ display:none; }
.insCard{
  background: rgba(0,0,0,.88);
  border: 3px solid rgba(215,180,90,.55);
  border-radius: 18px;
  padding: 18px 22px;
  min-width: 320px;
  box-shadow: 0 22px 48px rgba(0,0,0,.55);
}
.insTitle{
  font-size: 28px;
  font-weight: 900;
  letter-spacing: .02em;
  color: #f7e6b0;
  margin-bottom: 12px;
}
.insRow{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
.insRow + .insRow{ margin-top: 12px; }
.insInput{
  width: 140px;
  height: 44px;
  border-radius: 12px;
  border: 2px solid rgba(215,180,90,.35);
  background: rgba(0,0,0,.25);
  color: #f7e6b0;
  font-size: 22px;
  font-weight: 900;
  text-align:center;
}
.insHint{
  font-size: 16px;
  color: rgba(255,255,255,.75);
  text-align:center;
}

.popupOverlay{
  /* v137C: Make the result popup *only* cover the popup card, so underlying controls (DEAL) remain clickable. */
  pointer-events:auto;
  position:fixed;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%);
  display:flex;
  align-items:center;
  justify-content:center;
  background: transparent;
  /* v88: Must appear above Settings/About modals (modalOverlay uses 10000). */
  z-index: var(--z-popup);
}
.popupOverlay.hidden{ display:none; }
.popupCard{
  pointer-events:auto;
  background: rgba(0,0,0,.88);
  border: 3px solid rgba(215,180,90,.55);
  border-radius: 18px;
  padding: 18px 22px;
  min-width: 280px;
  box-shadow: 0 22px 48px rgba(0,0,0,.55);
}
.popupCard.splitMode{
  /* v138C: Split results table needs a bit more room. */
  min-width: min(92vw, 720px);
  max-width: min(92vw, 720px);
}
.popupText{
  font-size: 28px;
  font-weight: 900;
  letter-spacing: .02em;
  color: #f7e6b0;
  white-space: pre-line;
}

/* v138C: Split-round results table */
.splitResults{
  /* v141C: scale split-results popup typography up ~20% for readability */
  font-size: 22px;
  font-weight: 900;
  letter-spacing: .01em;
  color: #f7e6b0;
  white-space: normal;
}
.srDealer{
  font-size: 24px;
  margin-bottom: 10px;
}
.srRow{
  /* v142C: Use flex row so spacing is symmetric: label‚Üîcards == cards‚Üîtotal == total‚Üîoutcome.
     Totals/outcomes stay close to the cards, while the cards block can expand as more cards are present. */
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}
.srHandLabel{
  width: 110px;
  flex: 0 0 110px;
  font-size: 22px;
  white-space: nowrap;
  opacity: .95;
}
.srCards{
  display:flex;
  flex: 0 1 auto;
  min-width: 0;
  flex-wrap: wrap;
  gap: 6px;
  align-items:center;
}
.miniCard{
  /* v140C: bigger mini-cards + 100% larger rank text */
  width: 42px;
  height: 56px;
  border-radius: 6px;
  background: rgba(245,245,245,.96);
  border: 2px solid rgba(215,180,90,.55);
  color: #111;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 32px;
  font-weight: 1000;
  line-height: 1;
  box-shadow: 0 6px 14px rgba(0,0,0,.35);
}
.srHandTotal{
  font-size: 22px;
  opacity: .95;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
}
.srHandOutcome{
  font-size: 22px;
  opacity: .95;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
}
.srTotal{
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid rgba(215,180,90,.35);
  font-size: 24px;
}





/* Generic modal (for Insurance) - dims cards only via .area.dim */
.modalOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: var(--z-modalBase);
  background: transparent;
}
.modalOverlay.hidden{ display:none; }
.modalCard{
  pointer-events:auto;
  background: rgba(0,0,0,.90);
  border: 3px solid rgba(215,180,90,.55);
  border-radius: 18px;
  padding: 18px 22px;
  min-width: 320px;
  max-width: min(92vw, 520px);
  box-shadow: 0 22px 48px rgba(0,0,0,.55);
}
.modalTitle{
  font-size: 28px;
  font-weight: 900;
  letter-spacing: .02em;
  color: #f7e6b0;
  margin-bottom: 12px;
  font-family: inherit;
}
.modalRow{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top: 12px; }
.modalRow input{
  font-size: 22px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 2px solid rgba(215,180,90,.35);
  background: rgba(0,0,0,.25);
  color: #f7e6b0;
  width: 140px;
}
.modalNote{ color: rgba(255,255,255,.78); font-size: 16px; margin-top: 6px; }


/* Deal button highlight when a round is finished */
.dealReady{
  box-shadow: 0 0 0 3px rgba(80,180,255,.55), 0 0 18px rgba(255,220,90,.45);
  animation: dealPulse 1s ease-in-out infinite alternate;
}
@keyframes dealPulse{
  from{ filter: brightness(1.05); }
  to{ filter: brightness(1.25); }
}

  /* Settings table */
  .settingsModal{ max-width: 520px; }
  table.settingsTable{ width:100%; border-collapse: collapse; margin-top: 10px; }
  .settingsTable td{ padding: 10px 8px; vertical-align: middle; }
  .settingsTable tr + tr td{ border-top: 1px solid rgba(255,255,255,0.12); }
  .settingsLabel{ width: 55%; opacity: 0.95; }
  .settingsInput{ width: 100%; box-sizing: border-box; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.20); color: inherit; }

  /* Modal inputs should be readable and not inherit the game's HUD yellow */
  #settingsModal .settingsInput,
  #addChipsModal .settingsInput,
  #settingsModal .settingsSelect,
  #addChipsModal .settingsSelect{
    background: #ffffff;
    color: #000000;
    border: 1px solid rgba(0,0,0,0.25);
  }

  /* v87: Make locked settings controls visually obvious (even if not truly disabled). */
  #settingsModal .settingsSelect.lockedSelect{
    /* v88: Stronger disabled look */
    background: #d7d7d7;
    color: rgba(0,0,0,0.38);
    border: 1px solid rgba(0,0,0,0.14);
    cursor: not-allowed;
    opacity: 1;
  }
  #settingsModal .settingsSelect:disabled{
    background: #d7d7d7;
    color: rgba(0,0,0,0.38);
    border: 1px solid rgba(0,0,0,0.14);
    cursor: not-allowed;
    opacity: 1;
  }

  /* v88: Dim radio groups when rules are locked */
  #settingsModal .settingsRadios.lockedRadios{
    opacity: 0.55;
  }
  #settingsModal .settingsRadios.lockedRadios label{
    cursor: not-allowed;
  }
  #settingsModal .settingsInput::placeholder,
  #addChipsModal .settingsInput::placeholder{ color: rgba(0,0,0,0.45); }
  .settingsSelect{ width: 100%; box-sizing: border-box; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.20); color: inherit; }

.settingsRange{
  width: 100%;
  accent-color: rgba(215,180,90,.85);
}
#settingsModal .settingsRange:disabled{
  opacity: 0.45;
  filter: grayscale(0.65);
}
  .settingsRadios{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .settingsRadios label{ display:flex; gap:6px; align-items:center; cursor:pointer; }


  /* White modal (Settings / Add Chips) */
  .modal{
    pointer-events:auto;
    background: #ffffff;
    color: #111;
    border: 3px solid rgba(0,0,0,0.25);
    border-radius: 18px;
    padding: 18px 22px;
    min-width: 320px;
    max-width: min(92vw, 520px);
    box-shadow: 0 22px 48px rgba(0,0,0,.55);
  }
  .modal .modalTitle{
    color: #111;
  }
  .modal .modalText, .modal .modalNote{
    color: rgba(0,0,0,0.75);
  }

  /* Make Settings table easier to read */
  .settingsTable td{ font-size: 24px; }
  .settingsInput, .settingsSelect{ font-size: 22px; }

  /* Smaller buttons inside Settings/Add Chips modals */
  #settingsModal .btn, #addChipsModal .btn{
    font-size: 16px;
    padding: 10px 14px;
    border-radius: 14px;
  }


/* v44: control panel plain felt + leather rail */
.controls{
  background-image: url('images/felt_plain_controls.png');
  background-repeat: repeat;
  background-size: 400px auto;
  background-position: 0 0;
  background-color: rgba(0,0,0,0.75); /* fallback tint */
  border-top: none; /* we'll use leather rail instead */
}

/* subtle dark overlay for readability */
.controls::before{
  content:'';
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.18);
  pointer-events:none;
}

/* leather rail divider between table and controls */
.controls::after{
  content:'';
  position:absolute;
  left:0; right:0;
  top:-28px;
  height:28px;
  background:
    linear-gradient(180deg,
      rgba(0,0,0,0.10) 0%,
      rgba(0,0,0,0.04) 12%,
      rgba(92,52,28,0.98) 22%,
      rgba(64,34,18,0.99) 65%,
      rgba(18,9,5,1.00) 100%
    );
  box-shadow:
    0 -2px 8px rgba(0,0,0,1.35),
    0 2px 10px rgba(0,0,0,1.55);
border-bottom: 1px solid rgba(0,0,0,1.55);
  pointer-events:none;

  z-index: 5001;

  background-color: #3a2012;
}


/* v97B: Shuffle overlay shown over dealer lane (cycles opacity while riffle sound plays 3x) */
.shuffleOverlay{
  position:absolute;
  top:12px;
  left:12px;
  right:12px;
  bottom:12px;
  display:none;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index: 9000; /* above result popup */
}
.shuffleOverlay .shuffleBox{
  background:#ffffff;
  color:#1a57ff;
  font-weight:900;
  font-size:44px;
  letter-spacing:.04em;
  padding:18px 28px;
  border-radius:18px;
  box-shadow: 0 10px 24px rgba(0,0,0,.55);
  border: 2px solid rgba(26,87,255,.25);

  /* JS drives the exact timing; keep a sane default transition here. */
  opacity: 0;
  transition: opacity 500ms ease-in-out;
}




.prayerWrap{
  margin: 0 0 6px;
  height: 170px;          /* crop excess whitespace */
  overflow: hidden;
}
.prayerWrap .prayerFlags{
  left: 50%;
  transform: translateX(-50%);
  width: 368%;            /* +100% relative to previous ~276% */
  height: 440px;          /* slightly taller to keep aspect while cropped */
  margin: 0;
  top: 20px;             /* pull image up to reduce blank space */
  position: relative;
}

/* v107B: Render prayer flags as an <img> (more reliable than background div) */
.prayerWrap{
  margin: 0 0 6px !important;
  height: 190px !important;
  overflow: hidden !important;
}
.prayerFlagsImg{
  display: block;
  position: relative;
  left: 50%;
  transform: translateX(-50%);
  width: 420%;
  height: auto;
  max-width: none;
  top: -110px;           /* show cloth inside crop */
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.22));
  pointer-events: none;
}


.prayerWrap{
  margin: 4px 0 10px;
  padding: 0;
}
.prayerFlagsImg{
  display:block;
  position: relative;
  left: 50%;
  transform: translateX(-50%);
  width: 190%;
  max-width: none;
  height: auto;
  pointer-events: none;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.22));
}

/* v110B: Prayer flags as subtle ornamental divider */
.prayerWrap{
  margin: 6px 0 12px;
  padding: 0;
}
.prayerFlagsImg{
  display: block;
  position: relative;
  left: 50%;
  transform: translateX(-50%);
  width: 120%;
  max-width: none;
  height: auto;
  pointer-events: none;
  filter: none;
}

/* v111B: Sound controls in Settings */
.settingRow{ margin: 10px 0; }
.settingLabel{ font-weight: 700; margin-bottom: 4px; }
.settingHint{ font-size: 12px; opacity: 0.75; margin-top: 4px; }
.switch{ position: relative; display: inline-block; width: 46px; height: 24px; vertical-align: middle; margin-left: 10px; }
.switch input{ opacity: 0; width: 0; height: 0; }
.switch .slider{ position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; border-radius: 999px; background: rgba(255,255,255,0.18); transition: .2s; }
.switch .slider:before{ position: absolute; content: ""; height: 18px; width: 18px; left: 3px; top: 3px; border-radius: 50%; background: rgba(255,255,255,0.92); transition: .2s; }
.switch input:checked + .slider{ background: rgba(255,255,255,0.32); }
.switch input:checked + .slider:before{ transform: translateX(22px); }


/* Portrait prompt (iPhone/iPad) */
.rotateOverlay{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: rgba(0,0,0,0.72);
  backdrop-filter: blur(6px);
  z-index: 9999;
  text-align: center;
}
.rotateOverlay .box{
  max-width: 520px;
  background: rgba(10,10,10,0.75);
  border: 1px solid rgba(215,180,90,0.35);
  border-radius: 18px;
  padding: 22px 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.rotateOverlay .title{
  font-family: 'Libre Baskerville', serif;
  font-weight: 700;
  letter-spacing: .02em;
  margin: 0 0 10px;
  font-size: 20px;
  color: var(--gold);
}
.rotateOverlay .msg{
  margin: 0;
  font-size: 16px;
  line-height: 1.35;
  color: #e9e9e9;
}
.hidden{ display:none !important; }


/* v121C uniform scale wrapper (does not modify existing layout CSS) */
#gameViewport{
  position:fixed;
  inset:0;
  overflow:hidden;
}
#gameStage{
  position:absolute;
  left:0;
  top:0;
  /* IMPORTANT: prevent shrink-to-fit width (which collapses the v120B layout into a narrow column).
     Stretch to viewport while measuring; JS will lock to the measured baseline dimensions. */
  right:0;
  bottom:0;
  transform-origin: top left;
  will-change: transform;
}
.tooSmallOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.55);
  z-index:9998;
}
.tooSmallOverlay.hidden{ display:none; }
.tooSmallOverlay .box{
  max-width: 460px;
  margin: 0 16px;
  padding: 18px 18px 16px;
  border-radius: 14px;
  background: rgba(18,18,18,.92);
  border: 1px solid rgba(255,255,255,.14);
  color: #f7e6b0;
  text-align:center;
  font-family: 'Libre Baskerville', serif;
}
.tooSmallOverlay .title{
  font-weight:900;
  letter-spacing:.06em;
  text-transform:uppercase;
  margin-bottom:10px;
}
.tooSmallOverlay .msg{
  margin:0;
  opacity:.92;
  line-height:1.35;
}

/* v154D: Bankroll graph modal */
.bankrollGraphModal{ max-width: 760px; width: 94%; background:#ffffff; color:#111; border-radius:18px; padding:18px 18px 16px; }
.bankrollGraphModal .modalTitle{ color:#111; }
.bankrollGraphCanvas{ width:100%; height:340px; display:block; border-radius:12px; border:1px solid rgba(0,0,0,0.12); }
@media (max-width: 520px){
  .bankrollGraphCanvas{ height:260px; }
}


/* v154D: Bankroll graph modal */
#bankrollGraphModal .modal{ max-width: 760px; width: 92%; background: #ffffff; color: #111; border-radius: 18px; padding: 18px 18px 16px; }
#bankrollGraphModal .modalTitle{ color:#111; }
#bankrollGraphModal .modalText{ color:#222; font-size:14px; line-height:1.35; }

/* v161D: Leave-table door (top-left) */
.leaveDoor{
  position:absolute;
  top:14px;
  left:14px;
  width:clamp(90px, 11.25vw, 175px);
  height:auto;
  display:block;
  z-index: 9000; /* below modals (>=10000), above table art */
  text-decoration:none;
}
.leaveDoor img{
  width:100%;
  height:auto;
  display:block;
}
/* Tooltip */
.leaveDoor.tooltip{ position:absolute; }
.leaveDoor .tooltiptext{
  position:absolute;
  left:calc(100% + 10px);
  top:50%;
  transform:translateY(-50%);
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.15s ease;
  padding:6px 10px;
  border-radius:10px;
  font-size:13px;
  background:rgba(20,26,34,0.92);
  color:#fff;
  border:1px solid rgba(255,255,255,0.18);
  box-shadow:0 6px 18px rgba(0,0,0,0.35);
}
.leaveDoor:hover .tooltiptext,
.leaveDoor:focus .tooltiptext{
  opacity:1;
}


/* v161D: prayer flags header image in About modal */
#helpModal .prayerWrap{
  margin: 0 0 4px !important;   /* minimal gap before ABOUT */
  height: 210px !important;
  overflow: hidden !important;
}
#helpModal .prayerFlagsImg{
  width: 100% !important;
  max-width: 100% !important;
  display: block !important;
  position: relative !important;
  top: -70px !important;
  height: auto !important;
  pointer-events: none !important;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.18)) !important;
}


/* v161D: About header prayer flags */
#helpModal .aboutFlags{
  margin: -10px 0 0 !important;   /* pull up toward top of scroll area */
  padding: 0 !important;
  height: 230px !important;       /* visible window for flags */
  overflow: hidden !important;
}
#helpModal .aboutFlagsImg{
  width: 100% !important;         /* edge-to-edge */
  height: auto !important;
  display: block !important;
  position: relative !important;
  top: -85px !important;          /* lift so rope sits higher; less dead space */
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.18)) !important;
  pointer-events: none !important;
}
/* tighten gap before first heading */
#helpModal .scrollContent > h2:first-of-type{
  margin-top: 0 !important;
}
</style>
</head>
<body>

<a id="leaveTableDoor" class="leaveDoor tooltip"
   href="https://himalayagames.github.io"
   target="_blank" rel="noopener"
   aria-label="Leave table">
  <img src="images/yeti_exit_door.png" alt="Leave table">
  <span class="tooltiptext">Leave table</span>
</a>

<div aria-hidden="true" id="devBadge">DEV</div>
<div aria-hidden="true" class="rotateOverlay hidden" id="rotateOverlay">
<div class="box">
<div class="title">Rotate to landscape</div>
<p class="msg">Yeti Blackjack is designed for landscape screens. Please rotate your device to continue.</p>
</div>
</div><div aria-hidden="true" class="tooSmallOverlay hidden" id="tooSmallOverlay"><div class="box"><div class="title">Window too small</div><p class="msg">Please enlarge the window (or use a larger screen) to continue.</p></div></div><div id="gameViewport"><div id="gameStage"><div class="table">
<div class="area" id="dealerArea">
<div class="headerline"><span id="dealerLabel">DEALER</span><span class="value" id="dealerValue"></span></div>
<div class="lane" id="dealerLane"></div>
<div aria-hidden="true" class="shuffleOverlay hidden" id="shuffleOverlay"><div class="shuffleBox">SHUFFLING‚Ä¶</div></div>
</div>
<div class="area" id="playerArea">
<div class="headerline"><span id="playerLabel">PLAYER</span><span class="value" id="playerValue"></span></div>
<div class="lane" id="playerLane"></div>
</div>
</div><div class="controls">
<div class="controlsInner">
<div class="hudRow">
<div class="hudBox" id="bankrollBox">
<div class="label">BANKROLL</div>
<div class="amount" id="bankrollAmt">$500</div>
</div>
<div class="hudBox" id="betBox">
<div class="label">BET</div>
<div class="amount" id="betAmt">$25</div>
<div class="betControls">
<button aria-label="Decrease bet" class="arrowBtn arrowDown" id="betDown">‚ñº</button>
<button aria-label="Increase bet" class="arrowBtn arrowUp" id="betUp">‚ñ≤</button>
</div>
</div>
<div class="hudBox" id="actionBox">
<div class="label">CHIPS IN ACTION</div>
<div class="amount" id="actionAmt">$0</div>
</div>

<div class="hudBox" id="countBox" style="display:none;">
  <div class="label">COUNT</div>
  <div class="amount" id="countAmt"></div>
</div>

</div>
<div class="actionsRow">
<button class="btn" id="dealBtn">DEAL</button>
<button class="btn secondary" disabled="" id="hitBtn">HIT</button>
<button class="btn secondary" disabled="" id="standBtn">STAND</button>
<button class="btn secondary" disabled="" id="doubleBtn">DOUBLE</button>
<button class="btn secondary" disabled="" id="splitBtn">SPLIT</button>
<button class="btn secondary" disabled="" id="surrenderBtn">SURRENDER</button>
<button class="gear" id="gearBtn" title="Settings">‚öôÔ∏é</button>
<button aria-label="About &amp; Instructions" class="helpBtn" id="helpBtn" title="About &amp; Instructions">?</button>
<div aria-label="Shoe and discard indicator (visual mock)" class="shoeDiscardWrap">
<div aria-label="Shoe (mock)" class="trayIcon shoeTray" id="shoeIcon">
<div class="usable">
<div class="shoeFill"></div>
<div class="cutCardLine"></div>
</div>
</div>
<div aria-label="Discard pile (mock)" class="trayIcon discardTray" id="discardIcon">
<div class="usable">
<div class="discardFill"></div>
</div>
</div>
</div>
</div>
<div class="smallRow" id="devToolsRow">
<button class="toggle" id="testSplitsBtn">Test Splits: OFF</button>
<button class="toggle" id="testInsBJBtn">Test Insurance (BJ): OFF</button>
<button class="toggle" id="testInsNoBJBtn">Test Insurance (No BJ): OFF</button>
<button class="toggle" id="deckViewerBtn">Deck Viewer: OFF</button>
<button class="toggle" id="forcePlayerBJBtn">Force Player Blackjack</button>
<button class="toggle" id="forceDealerBJBtn">Force Dealer Blackjack</button>
</div>
</div>
</div><div aria-label="About and Instructions" aria-modal="true" class="modalOverlay hidden" id="helpModal" role="dialog">
<div class="scrollWrap" role="document">
<div class="scrollCard">
<div aria-hidden="true" class="scrollTopRoll"></div>
<div class="scrollContent">

<div class="aboutFlags" aria-hidden="true">
  <img class="aboutFlagsImg" src="images/tibetan_prayer_flags.png" alt="Tibetan prayer flags">
</div>

<h2>üèîÔ∏è About the Himalaya Casino</h2>
<p>High in the Himalayas stands a casino unlike any other.</p>



<p>Years ago, a legendary Las Vegas casino mogul vanished during a solo trek near Everest. The truth never reached the papers: he was captured by yetis. While awaiting his fate, he shuffled cards and taught them blackjack. The yetis were fascinated. What began as curiosity became joy, then pride. Instead of eating him, they made him their chief. Blackjack gave their community structure, competition, and a shared craft. Together, they built The Himalaya Casino, a high-altitude temple of green felt and clean odds. The mogul eventually returned home, but the casino remains‚Äîrun exclusively by yetis, for players who respect the game.</p>
<p><strong>Welcome to the Himalaya.</strong></p>
<h2>üÉè Blackjack Rules at the Himalaya</h2>
<h3>Objective</h3>
<p>Beat the dealer by getting closer to 21 without going over, or by having the dealer bust.</p>
<h3>Card Values</h3>
<ul>
<li>Cards 2‚Äì10: face value</li>
<li>Jack, Queen, King: 10</li>
<li>Ace: 1 or 11, whichever is more favorable</li>
</ul>
<h3>The Deal</h3>
<ul>
<li>You are dealt two cards, both face up</li>
<li>The dealer receives two cards: one face up, one face down</li>
</ul>
<h3>Blackjack</h3>
<ul>
<li>A blackjack is an Ace plus a 10-value card on the initial two-card deal only</li>
<li>A 21 made with more than two cards is not a blackjack</li>
<li>Blackjack pays 3:2</li>
<li>If both player and dealer have blackjack, the hand is a push</li>
</ul>
<h3>üéØ Player Options</h3>
<p>On your turn, you may choose:</p>
<ul>
<li><strong>Hit</strong> ‚Äì Take another card</li>
<li><strong>Stand</strong> ‚Äì Keep your current hand</li>
<li><strong>Double Down</strong> ‚Äì Double your bet and receive exactly one additional card</li>
<li><strong>Split</strong> ‚Äì If your first two cards are the same rank, split them into two hands, each with its own bet</li>
<li><strong>Surrender</strong> ‚Äì Give up the hand immediately and recover half your bet</li>
</ul>
<h3>üè≥Ô∏è Surrender Rules</h3>
<ul>
<li>Surrender is only available before taking any other action</li>
<li>When you surrender, you forfeit half of your original bet; the remaining half is returned</li>
<li>If the dealer shows an Ace or a 10-value card, surrender is resolved after the dealer checks for blackjack</li>
<li>Once you hit, stand, double, or split, surrender is no longer available</li>
</ul>
<p>Surrender is a strategic option meant to reduce losses in hands where the odds strongly favor the dealer.</p>
<h3>üßë‚Äçüè´ Dealer Rules</h3>
<ul>
<li>Dealer plays only after all player hands are completed</li>
<li>Dealer must hit on 16 or less</li>
<li>Dealer behavior on soft 17 depends on table settings:
            <ul>
<li>Dealer may hit soft 17 (H17)</li>
<li>Or stand on soft 17 (S17)</li>
</ul>
</li>
</ul>
<p>The soft-17 rule is configurable by the player in the Settings menu.</p>
<h3>üí• Busts and Pushes</h3>
<ul>
<li>Any hand totaling over 21 busts and loses immediately</li>
<li>If the dealer busts, all remaining player hands win</li>
<li>If you and the dealer finish with the same total, the hand is a push and your bet is returned</li>
</ul>
<h3>üõ°Ô∏è Insurance</h3>
<ul>
<li>Insurance is offered when the dealer‚Äôs upcard is an Ace</li>
<li>The maximum insurance bet is one-half of the original wager</li>
<li>Insurance pays 2:1 if the dealer has blackjack</li>
<li>If the dealer does not have blackjack, the insurance bet is lost</li>
</ul>
<p>Insurance is optional and rarely favorable over the long run.</p>
<h3>‚öôÔ∏è Game Settings</h3>
<p>The Himalaya allows you to customize how the game looks and plays.</p>
<p>Depending on your configuration, settings may include:</p>
<ul>
<li>Number of decks in the shoe</li>
<li>Table limits and starting bankroll</li>
<li>Dealer rules, including whether the dealer hits or stands on soft 17</li>
<li>Availability of options such as surrender and insurance</li>
</ul>
<h3>üÇ† Decks, Shoe, and Discards</h3>
<p>This game is played using a simulated casino shoe.</p>
<ul>
<li>The <strong>number of decks</strong> may be adjusted <strong>only before the first hand of a shoe</strong>, or <strong>after a shuffle has completed</strong>. Once cards are being dealt, the deck count is locked until the next shuffle.</li>
</ul>
<p>To help you keep track of the shoe, two visual indicators are shown in the control panel:</p>
<ul>
<li><strong>Shoe (left icon)</strong> ‚Äî shows the cards remaining in the shoe. The <strong>blue fill</strong> represents how much of the shoe is left, and the <strong>yellow line</strong> marks the position of the <strong>cut card</strong>. Cards are dealt from the <strong>bottom of the shoe</strong>, and the remaining stack gradually shrinks downward as play continues. When the cut card reaches the bottom, the current hand is completed and the shoe is shuffled before the next hand.</li>
<li><strong>Discard pile (right icon)</strong> ‚Äî shows cards that have already been dealt and discarded. The discard pile fills upward as the shoe empties.</li>
</ul>
<p>Together, these indicators show how deep you are into the shoe, making it easier to judge deck penetration and, for those who wish to do so, practice <strong>true count</strong> calculations while playing.</p>
<h3>When Settings Apply</h3>
<p>To keep gameplay consistent and fair:</p>

<ul>
<li>All settings except bankroll are locked after the first deal of a shoe</li>
<li>Locked settings become available again only after the shoe is completed</li>
<li>Bankroll may be adjusted at any time</li>
</ul>
<h3 style="margin-top:18px;">Game Persistence</h3>
<p style="margin-top:6px;">
  This game saves a few things automatically in your browser so you can close the tab and come back later.
</p>
<ul>
  <li><b>Bankroll and winnings graph</b> are saved after each completed round.</li>
  <li><b>We do not restore mid-hand.</b> If you refresh during a hand, the current hand is not recovered.</li>
  <li>Your data is stored locally in your browser (localStorage) on this device.</li>
  <li>If you clear site data / browser storage, use private browsing, or switch devices/browsers, your saved bankroll may not carry over.</li>
  <li>Use the <b>Reset Data</b> button (if enabled in your build) to clear saved data and start fresh.</li>

<h4 style="margin-top:14px;">Training Mode</h4>
<p style="margin-top:6px;">
  Training Mode lets you practice the <b>Knock-Out (KO)</b> blackjack counting system while you play.
  When enabled in <b>Settings</b>, a <b>COUNT</b> box appears on the top HUD row to the right of <b>Chips in Action</b>.
</p>
<ul>
  <li><b>Desktop / hover-capable devices:</b> the running count is revealed only while your cursor is over the COUNT box.</li>
  <li><b>Touch devices (no hover):</b> tap the COUNT box to toggle the running count on/off.</li>
  <li><b>Count updates:</b> only when cards become visible to you (no hidden face-down cards).</li>
</ul>

<table class="settingsTable" style="margin-top:10px; width:100%;">
  <tr>
    <td class="settingsLabel" style="width:40%;">Conditions</td>
    <td class="settingsLabel" style="width:30%;">IRC</td>
    <td class="settingsLabel" style="width:30%;">Key Count</td>
  </tr>
  <tr><td>1 deck</td><td>0</td><td>+2</td></tr>
  <tr><td>2 decks</td><td>‚àí4</td><td>+1</td></tr>
  <tr><td>4 decks</td><td>‚àí12</td><td>‚àí1</td></tr>
  <tr><td>6 decks</td><td>‚àí20</td><td>‚àí4</td></tr>
  <tr><td>8 decks</td><td>‚àí28</td><td>‚àí6</td></tr>
</table>
<p style="margin-top:8px; font-size: 13px; opacity: .9;">
  Note: The app displays only the <b>running count</b>. No true count, betting advice, or other calculations are performed.
</p>

</ul>
<h3>‚ùÑÔ∏è The Yeti Way</h3>
<p>At the Himalaya, the shuffle is honest, the rules are clear, and discipline matters. Play patiently, respect the math, and remember: sometimes the smartest move is knowing when to surrender.</p>
<p><strong>Good luck at the tables.</strong></p>
<div class="about-version">Version: <span id="versionText"></span></div>
</div>
<div class="scrollOkRow">
<button id="helpOkBtn">OK</button>
</div>
</div>
</div>
</div>

  <!-- v143 Step 1: refactor skeleton (engine/UI split). No behavior changes yet. -->
  <script src="cardholders.js"></script>

  <!-- Core (DOM-free) -->
  <script src="core/utils.js"></script>
  <script src="core/shoe.js"></script>
  <script src="core/ko_counter.js"></script>
  <script src="core/rules_blackjack.js"></script>
  <script src="core/engine.js"></script>

  <!-- Desktop UI (rendering + controls) -->
  <script src="ui/desktop/desktop_scale.js"></script>
  <script src="ui/desktop/desktop_audio.js"></script>
  <script src="ui/desktop/desktop_modals.js"></script>
  <script src="ui/desktop/desktop_render.js"></script>
  <script src="ui/desktop/desktop_ui.js"></script>

  <!-- Dev tools (optional) -->
  <script src="dev/diagnostics.js"></script>
  <script src="dev/deck_viewer.js"></script>

  <!-- v142C legacy monolith (still runs game). Will be decomposed in v143+ steps. -->
  <script src="persistence/storage.js"></script>
  <script src="persistence/ledger.js"></script>
  <script src="persistence/persist_controller.js"></script>

  <script src="ui/desktop/desktop_graph.js"></script>

  <script src="script.js"></script><div aria-label="Result" aria-modal="true" class="popupOverlay hidden" id="resultPopup" role="dialog">
<div class="popupCard">
<div class="popupText" id="popupText">Result</div>
</div>
</div><div aria-label="Game Over" aria-modal="true" class="modalOverlay hidden" id="endModal" role="dialog">
<div class="modalCard">
<div class="modalTitle">Thank you for playing</div>
<div class="modalNote">Game over.</div>
</div>
</div><div aria-label="Insurance" aria-modal="true" class="modalOverlay hidden" id="insuranceModal" role="dialog">
<div class="modalCard">
<div class="modalTitle" id="insuranceTitle">Insurance?</div>
<div class="modalNote" id="insuranceNote">Dealer shows an Ace. You may place an insurance bet (pays 2:1 if dealer has blackjack).</div>
<div class="modalRow" id="insuranceChoiceRow">
<button class="btn" id="insYesBtn" type="button">YES</button>
<button class="btn secondary" id="insNoBtn" type="button">NO</button>
</div>
<div class="modalRow" id="insuranceBetRow" style="display:none; flex-direction:column; align-items:stretch; gap:10px;">
<div style="display:flex; align-items:center; gap:10px;">
<div style="font-weight:900; color:#f7e6b0; min-width:44px;">Bet:</div>
<input id="insAmt" min="0" step="0.5" style="flex:1;" type="number"/>
</div>
<div class="modalNote" id="insuranceMaxNote" style="margin-top:-2px;"></div>
<div style="display:flex; gap:10px; justify-content:center;">
<button class="btn secondary" id="insCancelBtn" type="button">CANCEL</button>
<button class="btn" id="insConfirmBtn" type="button">CONFIRM</button>
</div>
</div>
</div>
</div>
<div aria-label="Final Running Count" aria-modal="true" class="modalOverlay hidden" id="finalCountModal" role="dialog">
  <div class="modalCard">
    <div class="modalTitle">Training Mode</div>
    <div class="modalNote">Final running count: <span id="finalCountValue">0</span></div>
    <div class="modalRow">
      <button class="btn" id="finalCountOkBtn" type="button">OK</button>
    </div>
  </div>
</div>
<div aria-label="Add Chips" aria-modal="true" class="modalOverlay hidden" id="addChipsModal" role="dialog" style="display:none; pointer-events:none;">
<div class="modal">
<div class="modalTitle">Add Chips</div>
<div class="modalText">Enter an amount to add to your bankroll (rounded to the nearest $5).</div>
<div class="modalRow" style="justify-content:center; margin-top:14px; gap:10px;">
<input class="settingsInput" id="addChipsAmt" inputmode="numeric" pattern="[0-9]*" placeholder="$0" style="flex:1; max-width:220px;" type="text"/>
</div>
<div class="modalRow" style="justify-content:center; margin-top:16px; gap:12px;">
<button class="btn secondary" id="addChipsCancelBtn" type="button">CANCEL</button>
<button class="btn defaultBtn" id="addChipsOkBtn" type="button">ACCEPT</button>
</div>
</div>
</div><div aria-label="Settings" aria-modal="true" class="modalOverlay hidden" id="settingsModal" role="dialog" style="display:none; pointer-events:none;">
<div class="modal settingsModal">
<div class="modalTitle">Settings</div>
<table class="settingsTable" role="presentation">
<tr>
<td class="settingsLabel">Bankroll</td>
<td>
<input class="settingsInput" id="settingsBankroll" inputmode="numeric" pattern="[0-9]*" type="text"/>
</td>
</tr>

<tr>
<td class="settingsLabel">Hide Hand Totals</td>
<td class="settingsRadios">
<label><input id="hideTotalsYes" name="hideTotals" type="radio" value="yes"/>Yes</label>
<label><input id="hideTotalsNo" name="hideTotals" type="radio" value="no"/>No</label>
</td>
</tr>

<tr>
<td class="settingsLabel">Number of Decks</td>
<td>
<select class="settingsSelect" id="settingsDecks">
<option value="2">2</option>
<option value="4">4</option>
<option value="6">6</option>
<option value="8">8</option>
</select>
</td>
</tr>

<tr>
<td class="settingsLabel">Random Cut Card</td>
<td class="settingsRadios">
<label><input id="randomCutYes" name="randomCut" type="radio" value="yes"/> Yes</label>
<label><input id="randomCutNo" name="randomCut" type="radio" value="no"/> No</label>
</td>
</tr>
<tr>
<td class="settingsLabel">Deck Penetration</td>
<td>
<div style="display:flex; align-items:center; gap:12px;">
  <input class="settingsRange" id="settingsPenetration" type="range" min="65" max="90" step="5" value="75"/>
  <div id="settingsPenetrationLabel" style="min-width:64px; text-align:right; font-weight:900;">75%</div>
</div>
</td>
</tr>

<tr>
<td class="settingsLabel">Hit on Soft 17</td>
<td class="settingsRadios">
<label><input id="hitSoft17Yes" name="hitSoft17" type="radio" value="yes"/> Yes</label>
<label><input id="hitSoft17No" name="hitSoft17" type="radio" value="no"/> No</label>
</td>
</tr>
<tr>
<td class="settingsLabel">Stay on Soft 17</td>
<td class="settingsRadios">
<label><input id="staySoft17Yes" name="staySoft17" type="radio" value="yes"/> Yes</label>
<label><input id="staySoft17No" name="staySoft17" type="radio" value="no"/> No</label>
</td>
</tr>
<tr>
<td class="settingsLabel">Surrender</td>
<td class="settingsRadios">
<label><input id="surrenderYes" name="surrender" type="radio" value="yes"/> Yes</label>
<label><input id="surrenderNo" name="surrender" type="radio" value="no"/> No</label>
</td>
</tr>
<tr>
<td class="settingsLabel">Game Sounds</td>
<td class="settingsRadios">
<label><input id="gameSoundsYes" name="gameSounds" type="radio" value="yes"/> Yes</label>
<label><input id="gameSoundsNo" name="gameSounds" type="radio" value="no"/> No</label>
</td>
</tr>
<tr>
<td class="settingsLabel">Soundtrack</td>
<td class="settingsRadios">
<label><input id="soundtrackYes" name="soundtrack" type="radio" value="yes"/> Yes</label>
<label><input id="soundtrackNo" name="soundtrack" type="radio" value="no"/> No</label>
</td>
</tr>
<tr>
<td class="settingsLabel">Training Mode</td>
<td class="settingsRadios">
<label><input id="trainingModeYes" name="trainingMode" type="radio" value="yes"/> Yes</label>
<label><input id="trainingModeNo" name="trainingMode" type="radio" value="no"/> No</label>
</td>
</tr>
</table>
<div class="modalRow" style="justify-content:center; margin-top:10px; gap:12px;">
<button class="btn secondary" id="graphWinningsBtn" type="button">GRAPH WINNINGS</button>
<button class="btn secondary" id="clearDataBtn" type="button">CLEAR DATA</button>
</div>
<div class="modalRow" style="justify-content:center; margin-top:14px; gap:12px;">
<button class="btn secondary" id="settingsCloseBtn" type="button">CLOSE</button>
<button class="btn defaultBtn" id="settingsSaveBtn" type="button">ACCEPT</button>
</div>
</div>
</div><div aria-label="Bankroll Graph" aria-modal="true" class="modalOverlay hidden" id="bankrollGraphModal" role="dialog">
  <div class="modal bankrollGraphModal">
    <div class="modalTitle" id="bankrollGraphTitle">Bankroll per Hand</div>
    <div class="modalText" id="bankrollGraphNote" style="margin-top:6px;">
      Showing your bankroll after each completed hand (last 2,000 hands).
    </div>
    <div style="margin-top:12px;">
      <canvas id="bankrollGraphCanvas" class="bankrollGraphCanvas"></canvas>
    </div>
    <div class="modalRow" style="justify-content:center; margin-top:14px; gap:12px;">
      <button class="btn defaultBtn" id="bankrollGraphCloseBtn" type="button">CLOSE</button>
    </div>
  </div>
</div><div aria-label="Clear Data" aria-modal="true" class="modalOverlay hidden" id="clearDataModal" role="dialog">
  <div class="modal" style="max-width:640px; width:92%; background:#ffffff; color:#111; border-radius:18px; padding:18px 18px 16px;">
    <div class="modalTitle" style="color:#111;">Clear Saved Data</div>
    <div class="modalText" id="clearDataText" style="margin-top:10px; font-size:14px; line-height:1.35; color:#222;">
      This will delete all saved bankroll + graph history and reset your bankroll to <b>$500</b>. Is this what you want?
    </div>
    <div class="modalRow" style="justify-content:center; margin-top:16px; gap:12px;">
      <button class="btn secondary" id="clearDataNoBtn" type="button">NO</button>
      <button class="btn defaultBtn" id="clearDataYesBtn" type="button">YES</button>
    </div>
  </div>
</div><div aria-label="About" aria-modal="true" class="modalOverlay hidden" id="aboutModal" role="dialog" style="display:none; pointer-events:none;">
<div class="modal" style="max-width:640px; width:92%; background:#ffffff; color:#111; border-radius:18px; padding:18px 18px 16px;">
<div class="modalTitle" style="color:#111;">About</div>
<pre id="aboutFlags" style="text-align:center;margin-bottom:12px;"></pre></div>
<div id="aboutText" style="white-space:pre-wrap; margin:10px 0 0; font-size:14px; line-height:1.35; color:#111;">
<div class="modalRow" style="justify-content:center; margin-top:14px; gap:12px;">
<button class="btn defaultBtn" id="aboutCloseBtn" type="button">CLOSE</button>
</div>
</div>
</div><div aria-label="Funds" aria-modal="true" class="modalOverlay hidden" id="brokeModal" role="dialog" style="display:none; pointer-events:none;">
<div class="modalCard">
<div class="modalTitle" id="fundsTitle">Insufficient Funds</div>
<div class="modalNote" id="fundsNote" style="font-size:18px;">You don't have enough bankroll.</div>
<div class="modalRow" id="fundsChoiceRow" style="justify-content:center; margin-top:16px; gap:12px;">
<button class="btn" id="addFundsBtn" type="button">ADD CHIPS</button>
<button class="btn secondary" id="continueHandBtn" type="button">CONTINUE HAND</button>
<button class="btn secondary" id="leaveTableBtn" style="display:none;" type="button">LEAVE TABLE</button>
</div>
<div class="modalRow" id="fundsAddRow" style="display:none; flex-direction:column; align-items:stretch; gap:10px; margin-top:12px;">
<div style="display:flex; align-items:center; gap:10px;">
<div style="font-weight:900; color:#f7e6b0; min-width:54px;">Add:</div>
<input id="fundsAmt" min="0.5" step="0.5" style="flex:1;" type="number">
</input></div>
<div style="display:flex; gap:10px; justify-content:center;">
<button class="btn secondary" id="fundsCancelBtn" type="button">CANCEL</button>
<button class="btn" id="fundsConfirmBtn" type="button">CONFIRM</button>
</div>
</div>
</div>
</div><div aria-label="Insurance Result" aria-modal="true" class="modalOverlay hidden" id="insuranceResultModal" role="dialog">
<div class="modalCard">
<div class="modalTitle" id="insuranceResultTitle">Insurance</div>
<div class="modalNote" id="insuranceResultText">Result</div>
<div class="modalRow" style="margin-top:16px;">
<button class="btn" id="insResultOkBtn" type="button">OK</button>
</div>
</div>
</div></div></div>


<!--
  IMPORTANT (v84 Safari fix):
  This project previously had a large legacy INLINE <script> block here AND an external script.js.
  Safari was executing the inline legacy path, so changes in script.js appeared to do nothing.

  DO NOT reintroduce inline gameplay logic here. Keep a single source of truth:
    - index.html: markup + styles
    - script.js: all game logic + animations
-->
<!-- Help Scroll Modal -->




<!-- Terminal end-state modal (Leave Table) -->


<!-- Add Chips Modal (virtual chips, not real money) -->

<!-- Settings Modal -->

<!-- About (attribution) -->



</body>
</html>